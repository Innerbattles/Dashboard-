<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<title>üèÅ Leaderboard ‚Äî Aesthetic</title>
<style>
  :root{
    --vh: 1vh;
    --from:#B4DB61; --to:#06BBA3; --ink:#0b1a13;
    --glass: rgba(255,255,255,.38);
    --glass-strong: rgba(255,255,255,.55);
  }
  html,body{margin:0;height:100%;width:100%;background:#fff;color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;overflow:hidden;}
  /* Animated background */
  body::before, body::after{
    content:""; position:fixed; inset:-20%;
    background: radial-gradient(40% 40% at 20% 20%, rgba(255,255,255,.35), transparent),
                radial-gradient(35% 35% at 80% 10%, rgba(255,255,255,.25), transparent),
                radial-gradient(30% 30% at 50% 90%, rgba(255,255,255,.18), transparent);
    z-index:0; pointer-events:none; mix-blend-mode:soft-light; animation:float 22s linear infinite;
  }
  body::after{ animation-direction:reverse; animation-duration:27s; opacity:.7; }
  @keyframes float{ 0%{transform:translate3d(0,0,0)} 50%{transform:translate3d(2%, -2%, 0)} 100%{transform:translate3d(0,0,0)} }

  #board{
    position:relative; z-index:1;
    width:100vw;height:100vh; padding:calc(1.2*var(--vh)) calc(1.6*var(--vh)); box-sizing:border-box;
    background:linear-gradient(135deg,var(--from),var(--to));
    display:flex;flex-direction:column;gap:calc(0.8*var(--vh));
  }

  /* Header */
  h2{
    margin:0;text-align:center;font-weight:900;letter-spacing:.3px;
    font-size:calc(4.0*var(--vh)); line-height:1.1;
    filter: drop-shadow(0 1px 0 rgba(0,0,0,.1));
  }
  .chips{
    display:flex;gap:calc(.6*var(--vh));flex-wrap:wrap;
    justify-content:center;margin-top:calc(-.3*var(--vh));
  }
  .chip{
    padding:calc(.35*var(--vh)) calc(.8*var(--vh));
    border-radius:999px;
    background:var(--glass);
    backdrop-filter: blur(6px);
    border:1px solid rgba(255,255,255,.35);
    font-weight:800;font-size:calc(1.5*var(--vh));
    box-shadow: 0 6px 16px rgba(0,0,0,.08) inset, 0 1px 0 rgba(255,255,255,.4);
  }

  /* Table area */
  .table-wrap{ flex:1; min-height:0; position:relative; }
  table{
    width:100%; height:100%;
    border-collapse:separate; border-spacing:0 10px; /* row gaps create "cards" */
    table-layout:fixed; font-size:calc(1.7*var(--vh));
  }
  thead th{
    position:sticky; top:0; z-index:2;
    background:var(--glass-strong);
    backdrop-filter: blur(6px);
    text-transform:uppercase; letter-spacing:.3px;
    font-size:calc(1.6*var(--vh)); font-weight:900; padding:calc(.6*var(--vh)) calc(0.9*var(--vh));
    border-radius:10px;
    border:1px solid rgba(0,0,0,.08);
  }
  th.col-rank, td.col-rank { width:7%; text-align:center; }
  th.col-agent,td.col-agent{ width:32%; text-align:left; }
  th.col-today,td.col-today{ width:12%; text-align:center; }
  th.col-day,  td.col-day  { width:7%;  text-align:center; }
  th.col-total,td.col-total{ width:12%; text-align:center; }

  /* Row "cards" */
  tbody td{
    background: rgba(255,255,255,.30);
    border-top:1px solid rgba(0,0,0,.06);
    border-bottom:1px solid rgba(0,0,0,.06);
    padding:calc(.7*var(--vh)) calc(0.9*var(--vh));
  }
  tbody tr td:first-child{ border-left:1px solid rgba(0,0,0,.06); border-top-left-radius:14px; border-bottom-left-radius:14px; }
  tbody tr td:last-child { border-right:1px solid rgba(0,0,0,.06); border-top-right-radius:14px; border-bottom-right-radius:14px; }
  tbody tr{ transition: transform .25s ease, box-shadow .25s ease; }
  tbody tr:hover{ transform: translateY(-2px); box-shadow:0 10px 24px rgba(0,0,0,.10); }

  /* Agent cell: avatar + name */
  .agent-wrap{ display:flex; align-items:center; gap:12px; min-width:0; }
  .avatar{
    flex:0 0 auto; width:44px; height:44px; border-radius:50%;
    background: linear-gradient(135deg, #ffffffcc, #ffffff55);
    border:1px solid rgba(0,0,0,.08);
    display:grid; place-items:center;
    font-weight:900; font-size:14px; letter-spacing:.5px;
    color:#0b1a13; text-transform:uppercase;
    box-shadow: 0 4px 14px rgba(0,0,0,.08);
  }
  .name{ font-weight:900; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

  /* Progress bars */
  .bar{
    position:relative; height:22px; border-radius:999px;
    background:rgba(255,255,255,.38); border:1px solid rgba(0,0,0,.06);
    overflow:hidden;
  }
  .bar > .fill{
    position:absolute; left:0; top:0; bottom:0; width:0%;
    background:linear-gradient(90deg, #0cfaa1, #06bba3);
    box-shadow: 0 0 16px rgba(12,250,161,.45);
    transition: width .8s ease;
  }
  .bar.total > .fill{
    background:linear-gradient(90deg, #86b7ff, #00b4d8);
    box-shadow: 0 0 16px rgba(0,180,216,.35);
  }
  .bar .value{
    position:relative; z-index:1; font-weight:900; font-size:90%;
  }

  /* Heat mini-bars in weekday cells */
  .spark{
    position:relative; height:18px; border-radius:8px; background:rgba(255,255,255,.42); border:1px solid rgba(0,0,0,.06);
    overflow:hidden; display:grid; place-items:center; font-weight:800; font-size:85%;
  }
  .spark .f{ position:absolute; left:0; top:0; bottom:0; width:0%; background:linear-gradient(90deg, rgba(255,255,255,.75), rgba(255,255,255,.15)); transition:width .6s ease; }

  /* Medals top 3 by Total */
  .medal{ font-weight:900; }
  .gold{ color:#a57c00; filter: drop-shadow(0 0 6px rgba(255,215,0,.45)); }
  .silver{ color:#6f7a89; filter: drop-shadow(0 0 6px rgba(192,192,192,.4)); }
  .bronze{ color:#8b5a2b; filter: drop-shadow(0 0 6px rgba(205,127,50,.35)); }

  /* Footer */
  #meta{ display:flex;justify-content:space-between;align-items:center; font-weight:800; font-size:calc(1.5*var(--vh)); }
  .ok{color:#157f3b}.err{color:#b00020}

  /* Page dots */
  .dots{ display:flex; gap:8px; align-items:center; }
  .dot{ width:8px; height:8px; border-radius:999px; background:rgba(255,255,255,.6); opacity:.55; }
  .dot.on{ opacity:1; background:#fff; box-shadow:0 0 8px rgba(255,255,255,.8); }

  /* Overlay (igual que versi√≥n previa) */
  #overlay{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.45);z-index:999}
  #card{
    padding:calc(4*var(--vh)) calc(6*var(--vh));
    border-radius:calc(3*var(--vh));
    background:linear-gradient(180deg,rgba(15,20,40,.95),rgba(15,20,40,.85));
    border:2px solid rgba(255,255,255,.25); color:#eaf3ff;
    text-align:center; animation:pop .45s ease-out;
    box-shadow:0 0 calc(8*var(--vh)) rgba(0,0,0,.3);
  }
  #who{font:900 calc(8.8*var(--vh))/1 system-ui;letter-spacing:.5px;text-shadow:0 3px 12px rgba(0,0,0,.5);margin-bottom:calc(.6*var(--vh))}
  #metaText{font:800 calc(2.8*var(--vh))/1.3 system-ui;opacity:.95}
  #todayCount{font:900 calc(5.4*var(--vh))/1 system-ui;margin-top:calc(1.2*var(--vh))}
  .accent{color:#0cfaa1;text-shadow:0 0 22px rgba(25,255,154,.6)}
  @keyframes pop{from{transform:scale(.8);opacity:0}to{transform:scale(1);opacity:1}}
  .confetti{position:absolute;top:-10vh;width:14px;height:22px;opacity:0;animation:fall 10s linear forwards}
  @keyframes fall{0%{transform:translateY(-10vh) rotate(0deg);opacity:0}10%{opacity:1}100%{transform:translateY(120vh) rotate(720deg);opacity:0}}
</style>
</head>
<body>
<div id="board">
  <h2>üèÅ Leaderboard</h2>
  <div class="chips">
    <div id="chipWeekly" class="chip">Week: ‚Äî</div>
    <div id="chipDaily" class="chip">Daily: ‚Äî</div>
  </div>

  <div class="table-wrap">
    <table id="tbl">
      <thead>
        <tr>
          <th class="col-rank">#</th>
          <th class="col-agent">Agent</th>
          <th class="col-today">Today</th>
          <th class="col-day">Wed</th>
          <th class="col-day">Thu</th>
          <th class="col-day">Fri</th>
          <th class="col-day">Sat</th>
          <th class="col-day">Mon</th>
          <th class="col-day">Tue</th>
          <th class="col-total">Total</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="meta">
    <div id="diag">Loading‚Ä¶</div>
    <div class="dots" id="dots"></div>
  </div>
</div>

<!-- Overlay SOLO por incrementos en Today -->
<div id="overlay">
  <div id="card">
    <div id="who" class="accent">Agent</div>
    <div id="metaText">just passed ‚Äî today! üéâ</div>
    <div id="todayCount">Today: 0</div>
  </div>
</div>

<script>
function setVHVar(){ const vh = window.innerHeight * 0.01; document.documentElement.style.setProperty('--vh', `${vh}px`); }
setVHVar(); window.addEventListener('resize', setVHVar);

const API_KEY        = "AIzaSyBWtgxYp3mPfjYVXeG_nYgE31lp4GicVFg";
const WEEKLY_SHEETID = "1pkNqNi_k5Ez1L1cYuvsT64m4oduGPJ4R7nLxesw6nrE";
const DAILY_ID_RAW   = "V1PtXIFUgb4Z3TWLNBll_HmLIiP6aeKe18rVIJClO8s";
const DAILY_IDS      = [DAILY_ID_RAW.startsWith("1")? DAILY_ID_RAW : ("1"+DAILY_ID_RAW), DAILY_ID_RAW];

const TIMEZONE       = "America/Tijuana";
const PAGE_SIZE      = 15;
const PAGE_MS        = 45000;
const DAILY_REFRESH  = 15000;
const WEEKLY_REFRESH = 5*60*1000;

let ALL = [];
let PAGE_INDEX = 0;
let INITIALIZED_TODAY = false;
let PREV_TODAY = new Map();
let PREV_TODAY_RANK = new Map();

const Cache = { weekly: {at: 0, tab: null, data: null}, daily : {at: 0, tab: null, data: null} };

function diag(t, cls){ document.getElementById('diag').innerHTML = `<span class="${cls||''}">${t}</span>`; }
function setChipWeekly(t){ document.getElementById('chipWeekly').textContent = `Week: ${t}`; }
function setChipDaily(t){ document.getElementById('chipDaily').textContent = `Daily: ${t}`; }
function getLocalDate(){ const s=new Date().toLocaleString('en-US',{timeZone:TIMEZONE}); return new Date(s); }
function isoWeek(d){ const x=new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())); const n=x.getUTCDay()||7; x.setUTCDate(x.getUTCDate()+4-n); const y=new Date(Date.UTC(x.getUTCFullYear(),0,1)); return {week:Math.ceil((((x-y)/86400000)+1)/7), year:x.getUTCFullYear()}; }
function weeksInISOYear(y){ const d=new Date(Date.UTC(y,11,31)); const day=d.getUTCDay(); return (day===4 || (d.getUTCDate()===31 && day===3))?53:52; }
function computeWeeklyTabName(){ const url = new URL(window.location.href); const override = url.searchParams.get('weeklyTab'); if (override) return override; const local=getLocalDate(); const hrs=local.getHours(); const dow=local.getDay(); const iw=isoWeek(local); let w=iw.week; const afterCut=(dow>4)||(dow===4&&hrs>=14); if(afterCut){ w++; const mx=weeksInISOYear(iw.year); if(w>mx){w=1;} } return `W${w}`; }
const emoji=/[\u{1F1E6}-\u{1F1FF}\u{1F300}-\u{1FAFF}\u{1F900}-\u{1F9FF}\u{2600}-\u{27BF}\u{FE0F}]/gu;
function normName(s){ return (s||"").replace(emoji,"").normalize('NFD').replace(/[\u0300-\u036f]/g,"").replace(/[^\x20-\x7E]/g,"").replace(/\s{2,}/g," ").trim().toUpperCase(); }
function normID(s){ return (s||"").toString().trim(); }
async function fetchSafeJSON(url, {tries=4, baseDelay=700}={}){ let lastErr; for(let i=0;i<tries;i++){ try{ const r = await fetch(url, {cache:"no-store"}); if(r.ok) return await r.json(); const text = await r.text(); if(r.status===429 || (r.status>=500 && r.status<600)){ const jitter=Math.random()*250; await new Promise(res=>setTimeout(res, baseDelay*Math.pow(2,i)+jitter)); continue; } throw new Error(`HTTP ${r.status} ‚Ä¢ ${text.slice(0,180)}`); }catch(e){ lastErr=e; const jitter=Math.random()*250; await new Promise(res=>setTimeout(res, baseDelay*Math.pow(2,i)+jitter)); } } throw lastErr || new Error("fetchSafeJSON: unknown"); }

async function readWeeklyTab(weeklyTab){
  const ranges=[`${weeklyTab}!A3:C96`,`${
weeklyTab}!D3:D96`,`${
weeklyTab}!F3:F96`,`${
weeklyTab}!H3:H96`,`${
weeklyTab}!J3:J96`,`${
weeklyTab}!L3:L96`,`${
weeklyTab}!N3:N96`,`${
weeklyTab}!O3:O96`].map(encodeURIComponent);
  const url=`https://sheets.googleapis.com/v4/spreadsheets/${WEEKLY_SHEETID}/values:batchGet?`+ranges.map(r=>`ranges=${r}`).join("&")+`&valueRenderOption=UNFORMATTED_VALUE&key=${API_KEY}`;
  const j=await fetchSafeJSON(url); const vr=j.valueRanges||[];
  const base=vr[0]?.values||[]; const toCol=v=>(v?.values||[]).map(r=>(r[0]??"").toString().trim());
  const d=toCol(vr[1]), f=toCol(vr[2]), h=toCol(vr[3]), jv=toCol(vr[4]), l=toCol(vr[5]), n=toCol(vr[6]), oT=toCol(vr[7]);
  const len=Math.max(base.length,d.length,f.length,h.length,jv.length,l.length,n.length,oT.length);
  const out=[];
  for(let i=0;i<len;i++){
    const id=normID(base[i]?.[0]??""); const name=(base[i]?.[1]??"").toString().trim();
    if(!id && !name) continue;
    out.push({ id,idKey:id, name, nameKey:normName(name),
      wed:parseInt(d[i]||0), thu:parseInt(f[i]||0), fri:parseInt(h[i]||0),
      sat:parseInt(jv[i]||0), mon:parseInt(l[i]||0), tue:parseInt(n[i]||0),
      total:parseInt(oT[i]||0), today:0 });
  }
  out.sort((a,b)=>(b.total||0)-(a.total||0));
  return out;
}
function fmtDailyTab(dt){ const m=new Intl.DateTimeFormat('en-US',{month:'short',timeZone:TIMEZONE}).format(dt); const dd=new Intl.DateTimeFormat('en-US',{day:'2-digit',timeZone:TIMEZONE}).format(dt); return `${m} ${dd}`; }
function getDailyTabCandidates(){ const url=new URL(window.location.href); const o=url.searchParams.get('dailyTab'); if(o) return [o]; const now=getLocalDate(); const y=new Date(now.getTime()-86400000); return [fmtDailyTab(now), fmtDailyTab(y)]; }

async function readDailyApproved(){
  const rangesFor=tab=>([`${tab}!A2:A34`,`${tab}!B2:B34`,`${tab}!C2:C34`,`${tab}!E2:E34`,`${tab}!F2:F34`,`${tab}!G2:G34`].map(encodeURIComponent));
  const tabs=getDailyTabCandidates();
  for(const id of DAILY_IDS){
    for(const tab of tabs){
      const url=`https://sheets.googleapis.com/v4/spreadsheets/${id}/values:batchGet?`+rangesFor(tab).map(r=>`ranges=${r}`).join("&")+`&valueRenderOption=UNFORMATTED_VALUE&key=${API_KEY}`;
      try{
        const j=await fetchSafeJSON(url); const vr=j.valueRanges||[];
        const A=vr[0]?.values||[], B=vr[1]?.values||[], C=vr[2]?.values||[];
        const E=vr[3]?.values||[], F=vr[4]?.values||[], G=vr[5]?.values||[];
        const mapByName=new Map(); const mapByID=new Map();
        function addPair(nmCell,idCell,valCell){
          const nm=(nmCell?.[0]??"").toString(); const id=(idCell?.[0]??"").toString().trim(); const v=parseInt((valCell?.[0]??0))||0;
          if(nm.trim()){ const nk=normName(nm); mapByName.set(nk,(mapByName.get(nk)||0)+v); }
          if(id){ mapByID.set(id,(mapByID.get(id)||0)+v); }
        }
        const rowsFK=Math.max(A.length,B.length,C.length); for(let i=0;i<rowsFK;i++) addPair(A[i],B[i],C[i]);
        const rowsRG=Math.max(E.length,F.length,G.length); for(let i=0;i<rowsRG;i++) addPair(E[i],F[i],G[i]);
        return {id, tab, mapByName, mapByID};
      }catch(e){ }
    }
  }
  return {id:DAILY_IDS[0], tab:tabs[0], mapByName:new Map(), mapByID:new Map()};
}

function isFresh(obj,ttl){ return (Date.now()-obj.at)<ttl; }
async function getWeeklyCached(weeklyTab, ttl=WEEKLY_REFRESH){
  if(Cache.weekly.data && Cache.weekly.tab===weeklyTab && isFresh(Cache.weekly, ttl)) return Cache.weekly.data;
  const data=await readWeeklyTab(weeklyTab); Cache.weekly={at:Date.now(),tab:weeklyTab,data}; return data;
}
async function getDailyCached(ttl=DAILY_REFRESH){
  if(Cache.daily.data && isFresh(Cache.daily, ttl)) return Cache.daily.data;
  const data=await readDailyApproved(); Cache.daily={at:Date.now(),tab:data.tab,data}; return data;
}

/* ---------- Helpers Visual ---------- */
function initials(name){
  const parts = (name||'').trim().split(/\s+/).slice(0,3);
  const letters = parts.map(p=>p[0]||'').join('').replace(/[^A-Za-z]/g,'').slice(0,2);
  return letters || 'AG';
}
function medalFor(index){ return index===0?'ü•á': index===1?'ü•à': index===2?'ü•â': ''; }
function medalClass(index){ return index===0?'gold': index===1?'silver': index===2?'bronze': ''; }

/* ---------- Render ---------- */
function renderDots(total, activeIndex){
  const dots = document.getElementById('dots');
  dots.innerHTML='';
  for(let i=0;i<total;i++){
    const d=document.createElement('div'); d.className='dot'+(i===activeIndex?' on':'');
    dots.appendChild(d);
  }
}
function renderPage(list, pageIndex){
  const tbody=document.querySelector("#tbl tbody");
  tbody.innerHTML="";
  const start=pageIndex*PAGE_SIZE;
  const page=list.slice(start, start+PAGE_SIZE);

  // Scales for bars
  const maxToday = Math.max(1, ...page.map(p=>p.today||0));
  const maxTotal = Math.max(1, ...page.map(p=>p.total||0));
  const toPct = (val,max)=> Math.max(3, Math.min(100, Math.round((val/max)*100)));

  page.forEach((p,i)=>{
    const rowIndex = start+i;
    const med = medalFor(rowIndex);
    const mClass = medalClass(rowIndex);
    const today = p.today||0, total = p.total||0;

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="col-rank ${mClass}">${med? `<span class="medal ${mClass}">${med}</span>` : rowIndex+1}</td>
      <td class="col-agent">
        <div class="agent-wrap">
          <div class="avatar">${initials(p.name)}</div>
          <div class="name" title="${p.name}">${p.name}</div>
        </div>
      </td>
      <td class="col-today">
        <div class="bar today"><div class="fill" style="width:0%"></div><div class="value">${today}</div></div>
      </td>
      <td class="col-day"><div class="spark"><div class="f" style="width:${toPct(p.wed||0,10)}%"></div>${p.wed||0}</div></td>
      <td class="col-day"><div class="spark"><div class="f" style="width:${toPct(p.thu||0,10)}%"></div>${p.thu||0}</div></td>
      <td class="col-day"><div class="spark"><div class="f" style="width:${toPct(p.fri||0,10)}%"></div>${p.fri||0}</div></td>
      <td class="col-day"><div class="spark"><div class="f" style="width:${toPct(p.sat||0,10)}%"></div>${p.sat||0}</div></td>
      <td class="col-day"><div class="spark"><div class="f" style="width:${toPct(p.mon||0,10)}%"></div>${p.mon||0}</div></td>
      <td class="col-day"><div class="spark"><div class="f" style="width:${toPct(p.tue||0,10)}%"></div>${p.tue||0}</div></td>
      <td class="col-total">
        <div class="bar total"><div class="fill" style="width:0%"></div><div class="value">${total}</div></div>
      </td>
    `;
    tbody.appendChild(tr);

    requestAnimationFrame(()=>{
      tr.querySelector('.bar.today .fill').style.width = toPct(today, maxToday)+'%';
      tr.querySelector('.bar.total .fill').style.width = toPct(total, maxTotal)+'%';
    });
  });

  const totalPages=Math.max(1, Math.ceil(list.length/PAGE_SIZE));
  renderDots(totalPages, Math.min(pageIndex,totalPages-1));
}

/* ---------- Overlay & Events ---------- */
const overlay=document.getElementById('overlay');
const whoEl=document.getElementById('who');
const metaTextEl=document.getElementById('metaText');
const todayEl=document.getElementById('todayCount');
function spawnConfetti(){
  document.querySelectorAll('.confetti').forEach(e=>e.remove());
  const colors=['#ffd166','#06d6a0','#118ab2','#ef476f','#ffffff','#19ff9a','#ff3a46'];
  for(let i=0;i<140;i++){
    const d=document.createElement('div'); d.className='confetti';
    const size=6+Math.random()*14, left=Math.random()*100, delay=Math.random()*0.8, dur=8+Math.random()*6;
    d.style.left=left+'vw'; d.style.background=colors[Math.floor(Math.random()*colors.length)];
    d.style.width=size+'px'; d.style.height=(size*1.6)+'px';
    d.style.animationDuration=dur+'s'; d.style.animationDelay=delay+'s';
    d.style.transform=`translateY(-10vh) rotate(${(Math.random()*360).toFixed(1)}deg)`;
    overlay.appendChild(d);
    d.addEventListener('animationend', ()=>d.remove());
  }
}
function showCongratsToday(winnerName, todayCount, passedName){
  whoEl.textContent=winnerName||'Agent';
  metaTextEl.textContent=passedName?`just passed ${passedName} today! üéâ`:`is climbing today! üéâ`;
  todayEl.textContent=`Today: ${todayCount}`;
  overlay.style.display='grid'; spawnConfetti();
  setTimeout(()=> overlay.style.display='none', 10000);
}
function buildTodayRanking(list){
  const copy=list.map(p=>({nameKey:p.nameKey,name:p.name,today:p.today||0}));
  copy.sort((a,b)=>(b.today||0)-(a.today||0));
  const rankMap=new Map(); const order=[];
  copy.forEach((p,i)=>{ rankMap.set(p.nameKey,i); order[i]=p.nameKey; });
  return {rankMap, order};
}
function detectTodayEvents(list){
  const {rankMap:CUR_RANK, order:CUR_ORDER}=buildTodayRanking(list);
  const events=[];
  list.forEach(p=>{
    const key=p.nameKey, prev=PREV_TODAY.get(key)??0, cur=p.today||0;
    if(cur>prev){
      const prevRank=PREV_TODAY_RANK.has(key)?PREV_TODAY_RANK.get(key):Number.POSITIVE_INFINITY;
      const curRank=CUR_RANK.get(key);
      let passed=null;
      if(curRank<prevRank){
        const behindIdx=curRank+1;
        if(behindIdx<CUR_ORDER.length){
          const behindKey=CUR_ORDER[behindIdx];
          const b=list.find(x=>x.nameKey===behindKey);
          if(b) passed=b.name;
        }
      }
      events.push({winnerName:p.name,today:cur,passedName:passed});
    }
  });
  PREV_TODAY.clear(); PREV_TODAY_RANK.clear();
  list.forEach(p=>PREV_TODAY.set(p.nameKey,p.today||0));
  const {rankMap}=buildTodayRanking(list); list.forEach(p=>PREV_TODAY_RANK.set(p.nameKey,rankMap.get(p.nameKey)));
  if(!events.length) return null; events.sort((a,b)=>b.today-a.today); return events[0];
}

/* ---------- Loops ---------- */
async function refreshWeekly(){
  try{
    const weeklyTab=computeWeeklyTabName(); setChipWeekly(weeklyTab);
    ALL=await getWeeklyCached(weeklyTab,WEEKLY_REFRESH);
    diag(`Weekly OK (${weeklyTab}) ‚Ä¢ ${ALL.length} agents`,'ok');
  }catch(e){ diag('Weekly error: '+(e.message||e),'err'); }
}
async function refreshDaily(){
  try{
    const {id,tab,mapByName,mapByID}=await getDailyCached(DAILY_REFRESH);
    setChipDaily(tab);
    if(!ALL.length){ await refreshWeekly(); if(!ALL.length) return; }
    ALL.forEach(p=>{
      const vID=mapByID.get(p.idKey), vNM=mapByName.get(p.nameKey);
      p.today = (typeof vID==='number' && !Number.isNaN(vID)) ? vID :
                (typeof vNM==='number' && !Number.isNaN(vNM)) ? vNM : 0;
    });
    let event=null;
    if(INITIALIZED_TODAY){ event=detectTodayEvents(ALL); }
    else {
      const {rankMap}=buildTodayRanking(ALL);
      ALL.forEach(p=>{ PREV_TODAY.set(p.nameKey,p.today||0); PREV_TODAY_RANK.set(p.nameKey,rankMap.get(p.nameKey)); });
      INITIALIZED_TODAY=true;
    }
    if(event) showCongratsToday(event.winnerName,event.today,event.passedName);
    diag(`Daily OK (${tab})`,'ok');
  }catch(e){ diag('Daily error: '+(e.message||e),'err'); }
}
function rotatePage(){
  if(!ALL.length) return;
  const totalPages=Math.max(1, Math.ceil(ALL.length/PAGE_SIZE));
  PAGE_INDEX=PAGE_INDEX%totalPages;
  renderPage(ALL,PAGE_INDEX);
  PAGE_INDEX=(PAGE_INDEX+1)%totalPages;
}
(async function start(){
  await refreshWeekly();
  await refreshDaily();
  rotatePage();
  setInterval(refreshWeekly, WEEKLY_REFRESH);
  setInterval(refreshDaily,  DAILY_REFRESH);
  setInterval(rotatePage,    PAGE_MS);
})();
</script>
</body>
</html>
