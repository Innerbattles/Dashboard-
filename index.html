<!DOCTYPE html>
<html lang='es'>
<head>
<meta charset='utf-8'/>
<meta name='viewport' content='width=device-width, initial-scale=1'/>
<title>Leaderboard ‚Äî TRON BG + CoD Rank-Up</title>

<style>
 :root{
  --vh: 1vh;

  /* Christmas Aesthetic Gradient */
  --from:#EAD7A4;   /* dorado pastel */
  --to:#C27A7A;     /* rojo vino suave */

  --ink:#0b1a13;
  --glass: rgba(255,255,255,.38);
  --glass-strong: rgba(255,255,255,.55);
}

  /* ===== GLOBAL BG ===== */
 html,body{
  margin:0;height:100%;width:100%;background:#fff;color:var(--ink);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
}

/* SOLO LA TABLA LIMITA EL SCROLL PARA QUE NO SE SALGA */
#board{
  position:relative;
  z-index:1;
  overflow:hidden; /* ‚Üê AQU√ç SE MUEVE EL overflow */
  width:100vw;
  height:100vh;
  padding:calc(1.2*var(--vh)) calc(1.6*var(--vh));
  box-sizing:border-box;
  background:linear-gradient(135deg,var(--from),var(--to));
  display:flex;
  flex-direction:column;
  gap:calc(0.8*var(--vh));
}
  body::after{ animation-direction:reverse; animation-duration:27s; opacity:.7; }
  @keyframes float{ 0%{transform:translate3d(0,0,0)} 50%{transform:translate3d(2%, -2%, 0)} 100%{transform:translate3d(0,0,0)} }

  #board{
    position:relative; z-index:1;
    width:100vw;height:100vh; padding:calc(1.2*var(--vh)) calc(1.6*var(--vh)); box-sizing:border-box;
    background:linear-gradient(135deg,var(--from),var(--to));
    display:flex;flex-direction:column;gap:calc(0.8*var(--vh));
  }

  h2{
    margin:0;text-align:center;font-weight:900;letter-spacing:.3px;
    font-size:calc(4.0*var(--vh)); line-height:1.1;
    filter: drop-shadow(0 1px 0 rgba(0,0,0,.1));
  }
  .chips{
    display:flex;gap:calc(.6*var(--vh));flex-wrap:wrap;
    justify-content:center;margin-top:calc(-.3*var(--vh));
  }
  .chip{
    padding:calc(.35*var(--vh)) calc(.8*var(--vh));
    border-radius:999px;
    background:var(--glass);
    backdrop-filter: blur(6px);
    border:1px solid rgba(255,255,255,.35);
    font-weight:800;font-size:calc(1.5*var(--vh));
    box-shadow: 0 6px 16px rgba(0,0,0,.08) inset, 0 1px 0 rgba(255,255,255,.4);
  }

  .table-wrap{ flex:1; min-height:0; position:relative; }
  table{
    width:100%; height:100%;
    border-collapse:separate; border-spacing:0 10px;
    table-layout:fixed; font-size:calc(1.7*var(--vh));
  }

  thead th{
    position:sticky; top:0; z-index:2;
    background:var(--glass-strong);
    backdrop-filter: blur(6px);
    text-transform:uppercase; letter-spacing:.3px;
    font-size:calc(1.6*var(--vh)); font-weight:900; padding:calc(.6*var(--vh)) calc(0.9*var(--vh));
    border-radius:10px;
    border:1px solid rgba(0,0,0,.08);
  }

  th.col-rank, td.col-rank { width:9%; text-align:center; }
  th.col-agent,td.col-agent{ width:30%; text-align:left; }
  th.col-today,td.col-today{ width:12%; text-align:center; }
  th.col-day,  td.col-day  { width:7%;  text-align:center; }
  th.col-total,td.col-total{ width:12%; text-align:center; }

  tbody td{
    background: rgba(255,255,255,.30);
    border-top:1px solid rgba(0,0,0,.06);
    border-bottom:1px solid rgba(0,0,0,.06);
    padding:calc(.7*var(--vh)) calc(0.9*var(--vh));
  }
  tbody tr td:first-child{
    border-left:1px solid rgba(0,0,0,.06);
    border-top-left-radius:14px; border-bottom-left-radius:14px;
  }
  tbody tr td:last-child {
    border-right:1px solid rgba(0,0,0,.06);
    border-top-right-radius:14px; border-bottom-right-radius:14px;
  }
  tbody tr{ transition: transform .25s ease, box-shadow .25s ease; }
  tbody tr:hover{ transform: translateY(-2px); box-shadow:0 10px 24px rgba(0,0,0,.10); }

  .agent-wrap{ display:flex; align-items:center; gap:12px; min-width:0; }
  .avatar{
    flex:0 0 auto; width:44px; height:44px; border-radius:50%;
    background: linear-gradient(135deg, #ffffffcc, #ffffff55);
    border:1px solid rgba(0,0,0,.08);
    display:grid; place-items:center;
    font-weight:900; font-size:14px; letter-spacing:.5px;
    color:#0b1a13; text-transform:uppercase;
    box-shadow: 0 4px 14px rgba(0,0,0,.08);
  }
  .name{
    font-weight:900; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
  }

  .bar{
    position:relative; height:22px; border-radius:999px;
    background:rgba(255,255,255,.38); border:1px solid rgba(0,0,0,.06); overflow:hidden;
  }
  .bar > .fill{
    position:absolute; left:0; top:0; bottom:0; width:0%;
    background:linear-gradient(90deg, #0cfaa1, #06bba3);
    box-shadow: 0 0 16px rgba(12,250,161,.45); transition: width .8s ease;
  }
  .bar.total > .fill{
    background:linear-gradient(90deg, #86b7ff, #00b4d8);
    box-shadow: 0 0 16px rgba(0,180,216,.35);
  }
  .bar .value{ position:relative; z-index:1; font-weight:900; font-size:90%; }

  .spark{
    position:relative; height:18px; border-radius:8px;
    background:rgba(255,255,255,.42); border:1px solid rgba(0,0,0,.06);
    overflow:hidden; display:grid; place-items:center;
    font-weight:800; font-size:85%;
  }
  .spark .f{
    position:absolute; left:0; top:0; bottom:0; width:0%;
    background:linear-gradient(90deg, rgba(255,255,255,.75), rgba(255,255,255,.15)); transition:width .6s ease;
  }

  #meta{
    display:flex;justify-content:space-between;align-items:center;
    font-weight:800; font-size:calc(1.5*var(--vh));
  }

  .dots{ display:flex; gap:8px; align-items:center; }
  .dot{
    width:8px; height:8px; border-radius:999px;
    background:rgba(255,255,255,.6); opacity:.55;
  }
  .dot.on{ opacity:1; background:#fff; box-shadow:0 0 8px rgba(255,255,255,.8); }

  /* ===== Medals ===== */
  .medal{
    display:inline-grid; place-items:center;
    width:38px; height:38px; border-radius:50%;
    margin-right:8px; font-weight:1000; font-size:16px; line-height:1;
    border:1px solid rgba(0,0,0,.1);
    box-shadow: 0 6px 16px rgba(0,0,0,.08), inset 0 0 16px rgba(255,255,255,.35);
  }
  .gold  { background:linear-gradient(180deg,#ffe9a6,#f2c94c); color:#1a1a1a; }
  .silver{ background:linear-gradient(180deg,#f0f3f6,#cfd6e0); color:#1a1a1a; }
  .bronze{ background:linear-gradient(180deg,#f3c9a1,#c88a4a); color:#1a1a1a; }

  #overlay.cod{
    position:fixed;inset:0;display:none;place-items:center;z-index:999;
    background: radial-gradient(900px 700px at 50% 40%,
      rgba(0,0,0,.2), rgba(0,0,0,.9) 60%, rgba(0,0,0,.96) 100%);
  }

  #overlay .burst{
    position:absolute; inset:0; pointer-events:none; opacity:.3;
    background:repeating-conic-gradient(from 0deg,
      rgba(245,214,107,.2) 0deg, transparent 6deg 12deg, rgba(245,214,107,.12) 18deg);
    mask: radial-gradient(ellipse at center, black 0%, transparent 60%);
    animation:spin 6s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  #card{
    position:relative; padding:calc(4*var(--vh)) calc(6*var(--vh));
    border-radius:calc(2.2*var(--vh));
    background:linear-gradient(180deg, #0f1417, #141b1f);
    border:2px solid rgba(245,214,107,.55); color:#fff;
    text-align:center; animation:pop .45s ease-out;
    box-shadow:0 0 50px rgba(0,0,0,.6), inset 0 0 28px rgba(245,214,107,.10);
    overflow:hidden;
  }

  #who{
    font:1000 calc(7.6*var(--vh))/1.02 system-ui;
    letter-spacing:.6px;margin-bottom:calc(.3*var(--vh));
    position:relative;
    z-index:2;
  }

  /* ===== SANTA ANIMADO ===== */
  .santa-wrap{
    position:absolute;left:50%;top:calc(3.8*var(--vh));
    transform:translateX(-130%) translateY(20px);
    opacity:0; transition:.7s ease-out;
    pointer-events:none; z-index:1;
  }
  .santa-wrap.show{
    transform:translateX(-130%) translateY(0); opacity:1;
  }

  .santa{width:80px;height:90px;position:relative;}
  .santa-hat-main{
    border-left:28px solid transparent;border-right:28px solid transparent;
    border-bottom:40px solid #e63946; position:absolute;top:0;left:50%;transform:translateX(-50%);
  }
  .santa-hat-brim{
    width:60px;height:12px;background:#fff;border-radius:999px;position:absolute;
    top:35px;left:50%;transform:translateX(-50%);box-shadow:0 0 6px rgba(0,0,0,.25);
  }
  .santa-hat-ball{
    width:14px;height:14px;background:#fff;border-radius:50%;position:absolute;
    right:-4px;top:22px;box-shadow:0 0 4px rgba(0,0,0,.3);
  }

  .santa-face{
    width:52px;height:42px;background:#f7d1a3;border-radius:22px;position:absolute;
    top:26px;left:50%;transform:translateX(-50%);box-shadow:0 0 8px rgba(0,0,0,.35);
  }
  .santa-eyes{
    position:absolute;top:13px;left:50%;transform:translateX(-50%);display:flex;gap:10px;
  }
  .santa-eyes span{
    width:6px;height:6px;background:#1b1b1b;border-radius:50%;
  }
  .santa-nose{
    width:10px;height:8px;background:#f3b47b;border-radius:999px;position:absolute;
    top:22px;left:50%;transform:translateX(-50%);
  }
  .santa-beard{
    width:64px;height:40px;background:#fff;border-radius:50px 50px 46px 46px;position:absolute;
    bottom:-14px;left:50%;transform:translateX(-50%);box-shadow:0 0 10px rgba(0,0,0,.3);
  }

  /* ‚ùÑÔ∏è NIEVE + üéÑ √ÅRBOLES */
  .flake{
    position:fixed;
    top:-20px;
    font-size:14px;
    pointer-events:none;
    opacity:.95;
    animation:fall linear forwards;
  }

  @keyframes fall{
    0%{ transform:translateY(0) translateX(0) rotate(0deg);}
    100%{transform:translateY(110vh) translateX(25px) rotate(360deg);}
  }
#xmasGif{
  position: fixed;
  top: 20px;
  right: 70px;
  width: 160px;         /* tama√±o del gif */
  height: auto;
  z-index: 9999;
  pointer-events: none;
  opacity: 95;
  filter: drop-shadow(0 0 6px rgba(0,0,0,0.4));
  transition: transform .6s ease;
}

#xmasGif:hover{
  transform: scale(1.1);
}
/* ===== ‚ùÑ Nieve en loop (CSS-only, global) ===== */
.snow-layer{
  position:fixed;
  inset:0;
  pointer-events:none;
  z-index:2;   /* encima del fondo y tablas, debajo del overlay (#overlay tiene 999) */
  overflow:hidden;
}

.snowflake-css{
  position:absolute;
  top:-10vh;
  color:#ffffff;
  opacity:0.85;
  font-size:14px;
  animation:snowLoop 12s linear infinite;
}

/* Animaci√≥n base de ca√≠da */
@keyframes snowLoop{
  0%{
    transform:translate3d(0,-10vh,0) rotate(0deg);
  }
  100%{
    transform:translate3d(0,110vh,0) rotate(360deg);
  }
}

/* Variaci√≥n por flake para que no caigan igualitos */
.snowflake-css:nth-child(1){
  left:5%;   font-size:28px; animation-duration:11s; animation-delay:0s;
}
.snowflake-css:nth-child(2){
  left:15%;  font-size:23px; animation-duration:14s; animation-delay:-3s;
}
.snowflake-css:nth-child(3){
  left:25%;  font-size:36px; animation-duration:12s; animation-delay:-6s;
}
.snowflake-css:nth-child(4){
  left:35%;  font-size:80px; animation-duration:15s; animation-delay:-1s;
}
.snowflake-css:nth-child(5){
  left:45%;  font-size:72px; animation-duration:10s; animation-delay:-4s;
}
.snowflake-css:nth-child(6){
  left:55%;  font-size:47px; animation-duration:13s; animation-delay:-7s;
}
.snowflake-css:nth-child(7){
  left:65%;  font-size:15px; animation-duration:11s; animation-delay:-2s;
}
.snowflake-css:nth-child(8){
  left:75%;  font-size:25px; animation-duration:16s; animation-delay:-5s;
}
.snowflake-css:nth-child(9){
  left:85%;  font-size:14px; animation-duration:12s; animation-delay:-8s;
}
.snowflake-css:nth-child(150){
  left:92%;  font-size:46px; animation-duration:13s; animation-delay:-9s;
}
.snowflake-css:nth-child(11){
  left:50%;  font-size:61px; animation-duration:9s;  animation-delay:-3s;
}
.snowflake-css:nth-child(12){
  left:30%;  font-size:18px; animation-duration:17s; animation-delay:-6s;
}
.snowflake-css:nth-child(8){
  right:79%;  font-size:25px; animation-duration:16s; animation-delay:-5s;
}
.snowflake-css:nth-child(9){
  right:105%;  font-size:14px; animation-duration:12s; animation-delay:-8s;
}
.snowflake-css:nth-child(150){
  right:92%;  font-size:46px; animation-duration:13s; animation-delay:-9s;
}
.snowflake-css:nth-child(11){
  right:950%;  font-size:61px; animation-duration:9s;  animation-delay:-3s;
}
.snowflake-css:nth-child(12){
  right:100%;  font-size:18px; animation-duration:17s; animation-delay:-6s;
}
/* ===== Variaciones para Pinitos ===== */

.snowflake-css:nth-child(13){
  left:12%;
  font-size:18px;
  animation-duration:14s;
  animation-delay:-3s;
}

.snowflake-css:nth-child(14){
  left:48%;
  font-size:22px;
  animation-duration:16s;
  animation-delay:-8s;
}

.snowflake-css:nth-child(15){
  left:102%;
  font-size:16px;
  animation-duration:13s;
  animation-delay:-5s;
}

.snowflake-css:nth-child(16){
  left:10%;
  font-size:20px;
  animation-duration:12s;
  animation-delay:-10s;
}
/* ===== üå≤ Pinos cayendo con oscilaci√≥n ===== */
.pineflake{
  position:fixed;
  top:-12vh;
  font-size:24px;
  color:#fff;
  pointer-events:none;
  opacity:0.95;
  animation:
    pineFall 14s linear infinite,
    pineWobble 3.5s ease-in-out infinite;
}

/* Variaciones por elemento */
.pineflake:nth-of-type(1){
  left: 10%;
  animation-duration: 15s, 3.5s;
  animation-delay: -3s, -1s;
}

.pineflake:nth-of-type(2){
  left: 30%;
  animation-duration: 18s, 4s;
  animation-delay: -6s, -2s;
}

.pineflake:nth-of-type(3){
  left: 55%;
  animation-duration: 16s, 3.2s;
  animation-delay: -2s, -1.2s;
}

.pineflake:nth-of-type(4){
  left: 75%;
  animation-duration: 20s, 4.4s;
  animation-delay: -5s, -2.2s;
}

.pineflake:nth-of-type(5){
  left: 90%;
  animation-duration: 17s, 3.8s;
  animation-delay: -4s, -1.4s;
}

/* Ca√≠da vertical */
@keyframes pineFall{
  0%{
    transform:translateY(-15vh);
  }
  100%{
    transform:translateY(120vh);
  }
}

/* Oscilaci√≥n lateral */
@keyframes pineWobble{
  0%{    transform:translateX(0); }
  25%{   transform:translateX(-12px); }
  50%{   transform:translateX(8px); }
  75%{   transform:translateX(-6px); }
  100%{  transform:translateX(0); }
}

/* Variaciones por elemento */
.pineflake:nth-of-type(1){
  left: 10%;
  animation-duration: 15s, 3.5s;
  animation-delay: -3s, -1s;
}

.pineflake:nth-of-type(2){
  left: 30%;
  animation-duration: 18s, 4s;
  animation-delay: -6s, -2s;
}

.pineflake:nth-of-type(3){
  left: 55%;
  animation-duration: 16s, 3.2s;
  animation-delay: -2s, -1.2s;
}

.pineflake:nth-of-type(4){
  left: 75%;
  animation-duration: 20s, 4.4s;
  animation-delay: -5s, -2.2s;
}

.pineflake:nth-of-type(5){
  left: 90%;
  animation-duration: 17s, 3.8s;
  animation-delay: -4s, -1.4s;
}
/* ===== GIF EN MOVIMIENTO SUAVE HORIZONTAL (Overlay) ===== */
#softGifContainer{
  position: fixed;
  top: 120px;
  left: -180px;
  width: 800px;
  height: auto;
  z-index: 9998;
  pointer-events: none;
  opacity: .95;
  animation: softMove 12s linear infinite;
  filter: drop-shadow(0 0 6px rgba(0,0,0,0.4));

  /* üí° Truco para ‚Äúquitar‚Äù el negro */
  mix-blend-mode: screen;   /* prueba tambi√©n lighten si quieres */
}
@keyframes softMove {
  0% {
    transform: translateX(-300px);   /* aparece fuera de la pantalla */
  }
  100% {
    transform: translateX(110vw);    /* se va completamente */
  }
}
/* ===== ‚≠ê ESTRELLAS BRILLANDO SUAVE ===== */
.star-layer{
  position: fixed;
  inset: 0;
  pointer-events: none;
  z-index: 4; /* üëà m√°s alto que la snow-layer (2) */
}

.star{
  position: absolute;
  color: #fff8c4; /* dorado suave */
  opacity: 0;
  font-size: 18px;  /* m√°s grandes para que se noten */
  animation: starBlink 3.5s ease-in-out infinite;
  filter: drop-shadow(0 0 10px rgba(255,255,200,.9));
}

@keyframes starBlink{
  0%   { opacity: 0;   transform: scale(0.9); }
  50%  { opacity: 1;   transform: scale(1.35); }
  100% { opacity: 0;   transform: scale(0.9); }
}
</style>
</head>

<body>

<!-- üéÖ GIF NAVIDE√ëO EN ESQUINA SUPERIOR DERECHA -->
<img id="xmasGif" 
     src="https://media2.giphy.com/media/v1.Y2lkPTc5MGI3NjExZnZzcXFhOWEycXA5M3EwN2R6dWM5Z2JrdWVwZzZnZzZ2bWJycWIxOSZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/lijWIJzOxYaBu6sdYt/giphy.gif" 
     alt="Santa Gif">
<!-- üéÖ GIF SUAVE EN MOVIMIENTO DIAGONAL LENTO -->
<img id="softGifContainer"
  src="https://media2.giphy.com/media/v1.Y2lkPTc5MGI3NjExd3ZjN3dlMDgzdGl3M2VlaXE1aXBmZ25heTB0MzBpd3VsdmQzMGFlbCZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9Zw/VFUl45qcwZ8mqIytUz/giphy.gif"
  alt="gif movimiento suave">

<!-- üå≤ Pinitos peque√±itos cayendo (FUERA del snow-layer) -->
<div class="pineflake">üå≤</div>
<div class="pineflake">üéÑ</div>
<div class="pineflake">üå≤</div>
<div class="pineflake">üéÑ</div>
<div class="pineflake">üéÑ</div>

<!-- ‚ùÑÔ∏è Capa de nieve en loop (CSS-only) -->
<div class="snow-layer" aria-hidden="true">
  <div class="snowflake-css">‚ùÑ</div>
  <div class="snowflake-css">‚ùÜ</div>
  <div class="snowflake-css">‚ùÖ</div>
  <div class="snowflake-css">‚ùÑ</div>
  <div class="snowflake-css">‚ùÜ</div>
  <div class="snowflake-css">‚ùÖ</div>
  <div class="snowflake-css">‚ùÑ</div>
  <div class="snowflake-css">‚ùÜ</div>
  <div class="snowflake-css">‚ùÖ</div>
  <div class="snowflake-css">‚ùÑ</div>
  <div class="snowflake-css">‚ùÜ</div>
  <div class="snowflake-css">‚ùÖ</div>
</div>
<!-- ‚≠ê Capa de estrellas brillando suavemente -->
<div class="star-layer" id="starLayer">
  <div class="star" style="top:8%; left:12%;  font-size:30px; animation-delay:0s;">‚ú¶</div>
  <div class="star" style="top:15%; left:40%; font-size:44px; animation-delay:.8s;">‚úß</div>
  <div class="star" style="top:22%; left:70%; font-size:52px; animation-delay:1.4s;">‚ú¶</div>
  <div class="star" style="top:35%; left:25%; font-size:28px; animation-delay:2.2s;">‚úß</div>
  <div class="star" style="top:48%; left:55%; font-size:75px;  animation-delay:1.1s;">‚ú¶</div>
  <div class="star" style="top:62%; left:15%; font-size:16px; animation-delay:2.8s;">‚úß</div>
  <div class="star" style="top:75%; left:80%; font-size:41px; animation-delay:1.9s;">‚ú¶</div>
  <div class="star" style="top:85%; left:35%; font-size:60px; animation-delay:.5s;">‚úß</div>
</div>

<div id='board'>
  <h2>üèÅ Leaderboard</h2>

  <div class='chips'>
    <div id='chipWeekly' class='chip'>Week: ‚Äî</div>
    <div id='chipDaily' class='chip'>Daily: ‚Äî</div>
  </div>

  <div class='table-wrap'>
    <table id='tbl'>
      <thead>
        <tr>
          <th class='col-rank'>#</th>
          <th class='col-agent'>Agent</th>
          <th class='col-today'>Today</th>
          <th class='col-day'>Wed</th>
          <th class='col-day'>Thu</th>
          <th class='col-day'>Fri</th>
          <th class='col-day'>Sat</th>
          <th class='col-day'>Mon</th>
          <th class='col-day'>Tue</th>
          <th class='col-total'>Total</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id='meta'>
    <div id='diag'>Loading‚Ä¶</div>
    <div class='dots' id='dots'></div>
  </div>
</div>

<!-- ===== OVERLAY ‚Äî RankUp Animation ===== -->
<div id='overlay' class='cod'>
  <div class='burst'></div>

  <div id='card'>

    <!-- üéÖ Santa animado -->
    <div class="santa-wrap" id="santaWrap">
      <div class="santa">
        <div class="santa-hat-main"></div>
        <div class="santa-hat-brim"></div>
        <div class="santa-hat-ball"></div>

        <div class="santa-face">
          <div class="santa-eyes"><span></span><span></span></div>
          <div class="santa-nose"></div>
          <div class="santa-beard"></div>
        </div>
      </div>
    </div>

    <!-- Badge / Rank info -->
    <div class='badge'>‚òÖ</div>

    <div id='who'>Agent</div>
    <div id='metaText'>just passed ‚Äî today! üéâ</div>

    <div id='rankLine'>
      <span class='delta' id='deltaBadge'>‚ñ≤ +1</span>
      <span class='position' id='posBadge'>#1</span>
    </div>

  </div>
</div>
<script>

function setVHVar(){
  const vh=window.innerHeight*0.01;
  document.documentElement.style.setProperty('--vh', `${vh}px`);
}
setVHVar();
window.addEventListener('resize', setVHVar);

/* ===== ‚ùÑÔ∏è NIEVE + üéÑ ARBOLITOS ===== */
const FLAKES = ["‚ùÑ","‚ùÖ","‚ùÜ","üå≤","üéÑ"];

function spawnFlakes() {
  for (let i = 0; i < 12; i++) {
    const flake = document.createElement("div");
    flake.className = "flake";
    flake.textContent = FLAKES[Math.floor(Math.random() * FLAKES.length)];

    const size = Math.random() * 14 + 10;
    const left = Math.random() * 100;

    flake.style.left = left + "vw";
    flake.style.fontSize = size + "px";
    flake.style.animationDuration = (6 + Math.random() * 6) + "s";

    document.body.appendChild(flake);
    flake.addEventListener("animationend", () => flake.remove());
  }
}

function stopFlakes(){
  document.querySelectorAll(".flake").forEach(f=>f.remove());
}

/* ===== Overlay Elements ===== */
const overlay=document.getElementById('overlay');
const whoEl=document.getElementById('who');
const metaTextEl=document.getElementById('metaText');
const deltaBadge=document.getElementById('deltaBadge');
const posBadge=document.getElementById('posBadge');
const santaWrap=document.getElementById('santaWrap');

/* ===== üéÖ Rank-Up Animation ===== */
function showRankUp({name,newRank,delta,passedName}){

  whoEl.textContent = name;
  metaTextEl.textContent = passedName
    ? `just passed ${passedName} today!`
    : `is climbing today!`;

  posBadge.textContent = `#${newRank+1}`;
  deltaBadge.textContent =
    (delta>0? "‚ñ≤ +" : delta<0? "‚ñº -" : "‚Äî ") + Math.abs(delta||0);
  deltaBadge.className = "delta " + (delta>0? "up" : "down");

  overlay.style.display="grid";
  santaWrap.classList.add("show");

  spawnFlakes();
  const flakeTimer = setInterval(spawnFlakes, 900);

  setTimeout(()=>{
    clearInterval(flakeTimer);
    stopFlakes();
    santaWrap.classList.remove("show");
    overlay.style.display="none";
  },10000);
}

/* ===== API KEYS ===== */
const API_KEY        = "AIzaSyBWtgxYp3mPfjYVXeG_nYgE31lp4GicVFg";
const WEEKLY_SHEETID = "1pkNqNi_k5Ez1L1cYuvsT64m4oduGPJ4R7nLxesw6nrE";
const DAILY_ID_RAW   = "1V1PtXIFUgb4Z3TWLNBll_HmLIiP6aeKe18rVIJClO8s";

const TIMEZONE       = "America/Tijuana";
const PAGE_SIZE      = 10;
const PAGE_MS        = 45000;
const DAILY_REFRESH  = 12000;
const WEEKLY_REFRESH = 5*60*1000;

let ALL_DATA=[];
let PAGE_INDEX=0;
let PREV_T=new Map();
let PREV_R=new Map();
let INITIALIZED=false;

function diag(t, cls){
  document.getElementById('diag').innerHTML =
    `<span class="${cls||''}">${t}</span>`;
}
function setChipWeekly(t){
  document.getElementById('chipWeekly').textContent = `Week: ${t}`;
}
function setChipDaily(t){
  document.getElementById('chipDaily').textContent = `Daily: ${t}`;
}

function getLocalDate(){
  const s=new Date().toLocaleString('en-US',{timeZone:TIMEZONE});
  return new Date(s);
}

function isoWeek(d){
  const x=new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
  const n=x.getUTCDay()||7;
  x.setUTCDate(x.getUTCDate()+4-n);
  const y=new Date(Date.UTC(x.getUTCFullYear(),0,1));
  return {week:Math.ceil((((x-y)/86400000)+1)/7), year:x.getUTCFullYear()};
}
function weeksInISOYear(y){
  const d=new Date(Date.UTC(y,11,31));
  const day=d.getUTCDay();
  return (day===4 || (d.getUTCDate()===31 && day===3))?53:52;
}

function computeWeeklyTabName(){
  const url=new URL(window.location.href);
  const override=url.searchParams.get('weeklyTab');
  if(override) return override;

  const local=getLocalDate();
  const hrs=local.getHours();
  const dow=local.getDay();
  const iw=isoWeek(local);
  let w=iw.week;

  const afterCut=(dow>4) || (dow===4 && hrs>=14);
  if(afterCut){
    w++;
    const mx=weeksInISOYear(iw.year);
    if(w>mx){ w=1; }
  }
  return `W${w}`;
}

const emoji =
  /[\u{1F1E6}-\u{1F1FF}\u{1F300}-\u{1FAFF}\u{1F900}-\u{1F9FF}\u{2600}-\u{27BF}\u{FE0F}]/gu;

function normName(s){
  return (s||"")
    .replace(emoji,"")
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g,"")
    .replace(/[^\x20-\x7E]/g,"")
    .replace(/\s{2,}/g," ")
    .trim()
    .toUpperCase();
}
function normID(s){ return (s||"").toString().trim(); }

/* ===== Safe Fetch with Retry ===== */
async function fetchSafeJSON(url, {tries=4, baseDelay=700} = {}) {
  let lastErr;
  for (let i = 0; i < tries; i++) {
    try {
      const r = await fetch(url, {
        cache: 'no-store',
        headers: {
          'Cache-Control': 'no-cache, no-store, max-age=0',
          'Pragma': 'no-cache'
        }
      });

      if (r.ok) return await r.json();

      const text = await r.text();
      if (r.status === 429 || (r.status >= 500 && r.status < 600)) {
        const jitter = Math.random() * 250;
        await new Promise(res=>setTimeout(res, baseDelay*Math.pow(2,i)+jitter));
        continue;
      }
      throw new Error(`HTTP ${r.status} ‚Ä¢ ${text.slice(0,180)}`);

    } catch(e){
      lastErr = e;
      const jitter = Math.random() * 250;
      await new Promise(res=>setTimeout(res, baseDelay*Math.pow(2,i)+jitter));
    }
  }
  throw lastErr || new Error("fetchSafeJSON: unknown");
}

async function readWeeklyTab(weeklyTab){
  const ranges=[
    `${weeklyTab}!A3:C96`,
    `${weeklyTab}!D3:D96`,
    `${weeklyTab}!F3:F96`,
    `${weeklyTab}!H3:H96`,
    `${weeklyTab}!J3:J96`,
    `${weeklyTab}!L3:L96`,
    `${weeklyTab}!N3:N96`,
    `${weeklyTab}!O3:O96`
  ].map(encodeURIComponent);

  const url=
    `https://sheets.googleapis.com/v4/spreadsheets/${WEEKLY_SHEETID}/values:batchGet?`
    + ranges.map(r=>`ranges=${r}`).join("&")
    + `&valueRenderOption=UNFORMATTED_VALUE&key=${API_KEY}`;

  const j=await fetchSafeJSON(url);
  const vr=j.valueRanges||[];

  const base=vr[0]?.values||[];
  const toCol=v=>(v?.values||[]).map(r=>(r[0]??"").toString().trim());

  const d=toCol(vr[1]), f=toCol(vr[2]), h=toCol(vr[3]),
        jv=toCol(vr[4]), l=toCol(vr[5]), n=toCol(vr[6]),
        oT=toCol(vr[7]);

  const len=Math.max(
    base.length, d.length, f.length, h.length,
    jv.length, l.length, n.length, oT.length
  );

  const out=[];
  for(let i=0;i<len;i++){
    const id = normID(base[i]?.[0] ?? "");
    const name = (base[i]?.[1] ?? "").toString().trim();
    if(!id && !name) continue;

    out.push({
      id,
      idKey:id,
      name,
      nameKey:normName(name),
      wed:parseInt(d[i]||0),
      thu:parseInt(f[i]||0),
      fri:parseInt(h[i]||0),
      sat:parseInt(jv[i]||0),
      mon:parseInt(l[i]||0),
      tue:parseInt(n[i]||0),
      total:parseInt(oT[i]||0),
      today:0
    });
  }

  out.sort((a,b)=>(b.total||0)-(a.total||0));
  return out;
}

function fmtDailyTab(dt){
  const m=new Intl.DateTimeFormat('en-US',{month:'short',timeZone:TIMEZONE}).format(dt);
  const dd=new Intl.DateTimeFormat('en-US',{day:'2-digit',timeZone:TIMEZONE}).format(dt);
  return `${m} ${dd}`;
}

function getDailyTabCandidates(){
  const url=new URL(window.location.href);
  const o=url.searchParams.get('dailyTab');
  if(o) return [o];

  const now=getLocalDate();
  const y=new Date(now.getTime()-86400000);
  return [fmtDailyTab(now), fmtDailyTab(y)];
}

async function readDailyApproved(){
  const rangesFor=tab=>[
    `${tab}!A2:A40`,
    `${tab}!B2:B40`,
    `${tab}!C2:C40`,
    `${tab}!E2:E40`,
    `${tab}!F2:F40`,
    `${tab}!G2:G40`
  ].map(encodeURIComponent);

  const tabs=getDailyTabCandidates();
  const DAILY_IDS=[DAILY_ID_RAW];

  for(const id of DAILY_IDS){
    for(const tab of tabs){
      const url=
        `https://sheets.googleapis.com/v4/spreadsheets/${id}/values:batchGet?`
        + rangesFor(tab).map(r=>`ranges=${r}`).join("&")
        + `&valueRenderOption=UNFORMATTED_VALUE&key=${API_KEY}`;

      try{
        const j=await fetchSafeJSON(url);
        const vr=j.valueRanges||[];

        const A=vr[0]?.values||[], B=vr[1]?.values||[], C=vr[2]?.values||[];
        const E=vr[3]?.values||[], F=vr[4]?.values||[], G=vr[5]?.values||[];

        const mapByName=new Map();
        const mapByID=new Map();

        function addPair(nmCell,idCell,valCell){
          const nm=(nmCell?.[0]??"").toString();
          const id=(idCell?.[0]??"").toString().trim();
          const v=parseInt((valCell?.[0]??0))||0;

          if(nm.trim()){
            const nk=normName(nm);
            mapByName.set(nk,(mapByName.get(nk)||0)+v);
          }
          if(id){
            mapByID.set(id,(mapByID.get(id)||0)+v);
          }
        }

        const rowsFK=Math.max(A.length,B.length,C.length);
        for(let i=0;i<rowsFK;i++) addPair(A[i],B[i],C[i]);

        const rowsRG=Math.max(E.length,F.length,G.length);
        for(let i=0;i<rowsRG;i++) addPair(E[i],F[i],G[i]);

        return {id, tab, mapByName, mapByID};

      }catch(e){
        // intentar siguiente tab
      }
    }
  }

  return {
    id:DAILY_IDS[0],
    tab:tabs[0],
    mapByName:new Map(),
    mapByID:new Map()
  };
}
function renderDots(total, activeIndex){
  const dots=document.getElementById('dots');
  dots.innerHTML='';
  for(let i=0;i<total;i++){
    const d=document.createElement('div');
    d.className='dot'+(i===activeIndex?' on':'');
    dots.appendChild(d);
  }
}

function renderPage(list, pageIndex){
  const tbody=document.querySelector("#tbl tbody");
  tbody.innerHTML="";

  const start=pageIndex*PAGE_SIZE;
  const page=list.slice(start, start+PAGE_SIZE);

  const maxToday=Math.max(1, ...page.map(p=>p.today||0));
  const maxTotal=Math.max(1, ...page.map(p=>p.total||0));

  const toPct=(v,max)=>Math.max(3, Math.min(100, Math.round((v/max)*100)));

  page.forEach((p,i)=>{
    const rowIndex=start+i;
    const today=p.today||0;
    const total=p.total||0;

    let medalHTML='';
    if (rowIndex===0) medalHTML = `<span class="medal gold" title="1st">ü•á</span>`;
    else if (rowIndex===1) medalHTML = `<span class="medal silver" title="2nd">ü•à</span>`;
    else if (rowIndex===2) medalHTML = `<span class="medal bronze" title="3rd">ü•â</span>`;

    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td class="col-rank">
        <div class="rankwrap">
          ${medalHTML}
          <span>${rowIndex+1}</span>
        </div>
      </td>
      <td class="col-agent">
        <div class="agent-wrap">
          <div class="avatar">
            ${(p.name||'').split(' ').map(x=>x[0]||'').join('').slice(0,2).toUpperCase()}
          </div>
          <div class="name" title="${p.name}">${p.name}</div>
        </div>
      </td>
      <td class="col-today">
        <div class="bar today">
          <div class="fill" style="width:0%"></div>
          <div class="value">${today}</div>
        </div>
      </td>
      <td class="col-day">
        <div class="spark"><div class="f" style="width:${toPct(p.wed||0,10)}%"></div>${p.wed||0}</div>
      </td>
      <td class="col-day">
        <div class="spark"><div class="f" style="width:${toPct(p.thu||0,10)}%"></div>${p.thu||0}</div>
      </td>
      <td class="col-day">
        <div class="spark"><div class="f" style="width:${toPct(p.fri||0,10)}%"></div>${p.fri||0}</div>
      </td>
      <td class="col-day">
        <div class="spark"><div class="f" style="width:${toPct(p.sat||0,10)}%"></div>${p.sat||0}</div>
      </td>
      <td class="col-day">
        <div class="spark"><div class="f" style="width:${toPct(p.mon||0,10)}%"></div>${p.mon||0}</div>
      </td>
      <td class="col-day">
        <div class="spark"><div class="f" style="width:${toPct(p.tue||0,10)}%"></div>${p.tue||0}</div>
      </td>
      <td class="col-total">
        <div class="bar total">
          <div class="fill" style="width:0%"></div>
          <div class="value">${total}</div>
        </div>
      </td>
    `;
    tbody.appendChild(tr);

    requestAnimationFrame(()=>{
      tr.querySelector('.bar.today .fill').style.width = toPct(today, maxToday)+'%';
      tr.querySelector('.bar.total .fill').style.width = toPct(total, maxTotal)+'%';
    });
  });

  const totalPages=Math.max(1, Math.ceil(list.length/PAGE_SIZE));
  renderDots(totalPages, Math.min(pageIndex,totalPages-1));
}

/* ===== Rank map & Detect Rank-Up ===== */
function buildTodayRanking(list){
  const copy=list.map(p=>({
    nameKey:p.nameKey,
    name:p.name,
    today:p.today||0
  }));
  copy.sort((a,b)=>(b.today||0)-(a.today||0));

  const rankMap=new Map();
  copy.forEach((p,i)=>rankMap.set(p.nameKey,i));
  return rankMap;
}

function detectAndCelebrate(list){
  const CUR_RANK=buildTodayRanking(list);
  let best=null;

  list.forEach(p=>{
    const key=p.nameKey;
    const prev=(PREV_T.get(key)||0);
    const cur=(p.today||0);
    const inc=cur - prev;

    if(inc>0){
      const pr=PREV_R.has(key)?PREV_R.get(key):Number.POSITIVE_INFINITY;
      const nr=CUR_RANK.get(key);

      let passed=null;
      if(nr<pr){
        for(let i=nr+1;i<=pr && i<list.length;i++){
          const behind=list.find(x=>CUR_RANK.get(x.nameKey)===i);
          if(behind){ passed=behind.name; break; }
        }
      }

      const delta=(pr===Number.POSITIVE_INFINITY)?0:(pr-nr);
      const ev={name:p.name,newRank:nr,delta,passedName:passed,inc};

      if(!best || ev.inc>best.inc || (ev.inc===best.inc && ev.newRank<best.newRank)){
        best=ev;
      }
    }
  });

  PREV_T.clear();
  PREV_R.clear();

  list.forEach(p=>{
    PREV_T.set(p.nameKey,p.today||0);
    PREV_R.set(p.nameKey, CUR_RANK.get(p.nameKey));
  });

  if(best) showRankUp(best);
}

/* ===== CACHES ===== */
async function getWeeklyCached(weeklyTab, ttl=WEEKLY_REFRESH){
  const Cache=window.__cacheW||(window.__cacheW={at:0,tab:null,data:null});
  if(Cache.data && Cache.tab===weeklyTab && (Date.now()-Cache.at)<ttl)
    return Cache.data;

  const data=await readWeeklyTab(weeklyTab);
  window.__cacheW={at:Date.now(),tab:weeklyTab,data};
  return data;
}

async function getDailyCached(ttl=DAILY_REFRESH-1000){
  const Cache=window.__cacheD||(window.__cacheD={at:0,tab:null,data:null});
  if(Cache.data && (Date.now()-Cache.at)<ttl) return Cache.data;

  const data=await readDailyApproved();
  window.__cacheD={at:Date.now(),tab:data.tab,data};
  return data;
}

/* ===== REFRESH FNS ===== */
async function refreshWeekly(){
  try{
    const weeklyTab=computeWeeklyTabName();
    setChipWeekly(weeklyTab);
    ALL_DATA=await getWeeklyCached(weeklyTab,WEEKLY_REFRESH);
    diag(`Weekly OK (${weeklyTab}) ‚Ä¢ ${ALL_DATA.length} agents`,'ok');
  }catch(e){
    diag('Weekly error: '+(e.message||e),'err');
  }
}

async function refreshDaily(){
  try{
    const {id,tab,mapByName,mapByID}=await getDailyCached(DAILY_REFRESH);
    setChipDaily(tab);

    if(!ALL_DATA.length){
      await refreshWeekly();
      if(!ALL_DATA.length) return;
    }

    ALL_DATA.forEach(p=>{
      const vID=mapByID.get(p.idKey);
      const vNM=mapByName.get(p.nameKey);
      p.today = (typeof vID==='number' && !Number.isNaN(vID))
        ? vID
        : (typeof vNM==='number' && !Number.isNaN(vNM))
          ? vNM
          : 0;
    });

    if(INITIALIZED){
      detectAndCelebrate(ALL_DATA);
    }else{
      const r=buildTodayRanking(ALL_DATA);
      ALL_DATA.forEach(p=>{
        PREV_T.set(p.nameKey,p.today||0);
        PREV_R.set(p.nameKey, r.get(p.nameKey));
      });
      INITIALIZED=true;
    }

    diag(`Daily OK (${tab})`,'ok');
  }catch(e){
    diag('Daily error: '+(e.message||e),'err');
  }
}

/* ===== ROTATE PAGES ===== */
function rotatePage(){
  if(!ALL_DATA.length) return;
  const totalPages=Math.max(1, Math.ceil(ALL_DATA.length/PAGE_SIZE));
  PAGE_INDEX=PAGE_INDEX%totalPages;
  renderPage(ALL_DATA,PAGE_INDEX);
  renderDots(totalPages, PAGE_INDEX);
  PAGE_INDEX=(PAGE_INDEX+1)%totalPages;
}

/* ===== START APP ===== */
(async function start(){
  await refreshWeekly();
  await refreshDaily();
  rotatePage();

  setInterval(refreshWeekly, WEEKLY_REFRESH);
  setInterval(refreshDaily,  DAILY_REFRESH);
  setInterval(rotatePage,    PAGE_MS);
})();

</script>
</body>
</html>
