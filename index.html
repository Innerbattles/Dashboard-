from IPython.display import HTML
HTML(r'''
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Endless Dashboard Transfers ‚Äî v12 (paginaci√≥n 15 c/40s)</title>
<style>
  :root{
    --bg:#fff; --text:#0b1a13;
    --panelFrom:#B4DB61; --panelTo:#06BBA3;
    --fk:#19ff9a; --rg:#ff3a46;
  }
  html,body{margin:0;height:100%;background:var(--bg);overflow:hidden}
  #wrap{position:fixed;inset:0;display:grid;place-items:center;background:var(--bg)}
  /* Subimos base a 16px para legibilidad */
  #stage{width:min(100vw,177.78vh);height:calc(min(100vw,177.78vh)/16*9);
         position:relative;color:var(--text);
         font:600 16px/1.35 system-ui,-apple-system,Segoe UI,Roboto,sans-serif}

  /* Header */
  #header{position:absolute;left:20px;top:20px;right:20px;
          display:flex;align-items:center;gap:12px}
  .brand{display:flex;gap:12px;align-items:center;
         background:rgba(0,0,0,.06);padding:12px 16px;
         border-radius:14px;border:1px solid rgba(0,0,0,.08);
         font-weight:700}
  .chip{display:inline-flex;align-items:center;gap:8px;
        padding:6px 12px;border-radius:999px;
        background:rgba(0,0,0,.06);border:1px solid rgba(0,0,0,.08);
        font-weight:800}
  .dot{width:12px;height:12px;border-radius:50%}
  .fk{background:var(--fk);box-shadow:0 0 6px var(--fk)}
  .rg{background:var(--rg);box-shadow:0 0 6px var(--rg)}
  #sheetTag{font-weight:900}

  /* Panel degradado */
  #board{position:absolute;left:20px;right:20px;top:88px;bottom:20px;
         background:linear-gradient(135deg,var(--panelFrom),var(--panelTo));
         border:1px solid rgba(0,0,0,.12);border-radius:18px;
         padding:18px;box-shadow:0 8px 28px rgba(0,0,0,.12)}
  #board h3{margin:0 0 14px 0;font:800 22px/1.2 system-ui;letter-spacing:.2px;color:#0a1a10}

  /* Tabla */
  .grid{display:grid;grid-template-columns:70px 1fr 180px 160px;gap:8px;align-items:center}
  .head{opacity:.9;font-weight:900;text-transform:uppercase;letter-spacing:.6px;font-size:14px}
  .cell{padding:12px 14px;background:rgba(255,255,255,.18);border-radius:12px}
  .rank{text-align:right;opacity:.95;font-weight:900}
  .agent{display:flex;align-items:center;gap:12px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis}
  .team{opacity:.95;font-weight:800}
  .trans{text-align:right;font-weight:900}

  /* Footer info (paginaci√≥n) */
  #footerInfo{position:absolute;right:26px;bottom:24px;
              background:rgba(255,255,255,.3);border:1px solid rgba(0,0,0,.12);
              padding:6px 10px;border-radius:10px;font:700 13px/1.1 system-ui}

  /* Overlay (overtake) */
  #overlay{position:absolute;inset:0;display:none;place-items:center;background:rgba(0,0,0,.35)}
  #card{padding:30px 44px;border-radius:22px;background:linear-gradient(180deg,rgba(15,20,40,.92),rgba(15,20,40,.78));
        border:1px solid rgba(255,255,255,.25);color:#eaf3ff;box-shadow:0 0 60px rgba(0,0,0,.25);
        text-align:center;animation:pop .5s ease-out}
  #who{font:900 78px/1.05 system-ui;letter-spacing:.5px;text-shadow:0 2px 10px rgba(0,0,0,.35)}
  #meta{font:800 30px/1.25 system-ui;opacity:.95;margin-top:8px}
  #trans{font:900 58px/1.05 system-ui;margin-top:14px}
  .accent-fk{color:#0cfaa1;text-shadow:0 0 22px rgba(25,255,154,.6)}
  .accent-rg{color:#ff5151;text-shadow:0 0 22px rgba(255,81,81,.6)}
  @keyframes pop{from{transform:scale(.9);opacity:0}to{transform:scale(1);opacity:1}}
  .confetti{position:absolute;top:-10vh;width:12px;height:18px;opacity:0;animation:fall linear forwards}
  @keyframes fall{0%{transform:translateY(-10vh) rotate(0deg);opacity:0}10%{opacity:1}100%{transform:translateY(120vh) rotate(720deg);opacity:0}}

  /* Diag */
  #diag{position:absolute;left:20px;bottom:20px;color:#0b1a13;background:rgba(0,0,0,.06);
        padding:10px 12px;border-radius:12px;border:1px solid rgba(0,0,0,.08);
        font:700 14px/1.3 system-ui;white-space:pre-wrap;max-width:72ch}
  .ok{color:#157f3b}.warn{color:#a86b00}.err{color:#b00020}
</style>
</head>
<body>
<div id="wrap"><div id="stage">

  <div id="header">
    <div class="brand">
      <div id="sheetTag">üìÖ Hoja: ‚Äî</div>
      <div class="chip"><span class="dot fk"></span>Filekeepers</div>
      <div class="chip"><span class="dot rg"></span>Rugrats</div>
      <div class="chip">‚ü≥ data 15s</div>
      <div class="chip">‚áÜ p√°gina 40s</div>
    </div>
  </div>

  <div id="board">
    <h3>üèÜ Leaderboard (bloques de 15)</h3>
    <div class="grid head">
      <div class="cell rank">#</div>
      <div class="cell">Agente</div>
      <div class="cell team">Equipo</div>
      <div class="cell trans">Transfer</div>
    </div>
    <div id="rows" class="grid"></div>
  </div>

  <div id="footerInfo">P√°gina ‚Äî / ‚Äî</div>

  <div id="overlay">
    <div id="card">
      <div id="who">Agente</div>
      <div id="meta">¬°acaba de rebasar! üéâ</div>
      <div id="trans">Transfer: 0</div>
    </div>
  </div>

  <div id="diag">Iniciando‚Ä¶</div>
</div></div>

<script>
/* ===== Config ===== */
const API_KEY   = "AIzaSyB0TtVnOafgkbRwCaqkSxPogGLUgyWqZaE";
const SHEET_ID  = "1V1PtXIFUgb4Z3TWLNBll_HmLIiP6aeKe18rVIJClO8s";
const TIMEZONE  = "America/Tijuana";
const REFRESH_MS= 15000;         // refresco de datos
const PAGE_MS   = 40000;         // cambio de p√°gina
const PER_TEAM_LIMITS = { fk: 32, rg: 33 }; // tama√±o m√°ximo esperado por equipo (para sanity)
/* Paginaci√≥n */
const PAGE_SIZE = 15;

const DIAG=document.getElementById('diag');
const sheetTag=document.getElementById('sheetTag');
const footerInfo=document.getElementById('footerInfo');

function diag(t,cls){ let tag=''; if(cls==='ok')tag='<span class=ok>OK</span> '; if(cls==='warn')tag='<span class=warn>WARN</span> '; if(cls==='err')tag='<span class=err>ERR</span> '; DIAG.innerHTML=tag+t; }

/* ===== Fecha -> nombre de hoja ===== */
function fmtSheetName(date){
  const m = new Intl.DateTimeFormat('en-US',{month:'short', timeZone:TIMEZONE}).format(date);
  const d = new Intl.DateTimeFormat('en-US',{day:'2-digit', timeZone:TIMEZONE}).format(date);
  return `${m} ${d}`; // "Oct 22"
}
function getSheetNamePlan(){
  const url = new URL(window.location.href);
  const override = url.searchParams.get('sheet');
  if (override) return {primary: override, fallback: null, reason:'override'};
  const now = new Date();
  const yday = new Date(now.getTime()-24*60*60*1000);
  return {primary: fmtSheetName(now), fallback: fmtSheetName(yday), reason:'auto'};
}

/* ===== Limpieza y helpers ===== */
const emoji=/[\u{1F1E6}-\u{1F1FF}\u{1F300}-\u{1FAFF}\u{1F900}-\u{1F9FF}\u{2600}-\u{27BF}\u{FE0F}]/gu;
const clean=s=>(s||"").replace(emoji,"").normalize('NFD').replace(/[\u0300-\u036f]/g,"").replace(/[^\x20-\x7E]/g,"").replace(/\s{2,}/g," ").trim()||"Agente";
function dot(team){return `<span class="dot ${team==='Filekeepers'?'fk':'rg'}"></span>`;}

/* ===== Render tabla (pagina actual) ===== */
function renderRows(list, pageIndex){
  const rows=document.getElementById('rows'); rows.innerHTML="";
  const start = pageIndex * PAGE_SIZE;
  const page = list.slice(start, start + PAGE_SIZE);
  page.forEach((p,i)=>{
    rows.insertAdjacentHTML('beforeend', `
      <div class="cell rank">${start + i + 1}</div>
      <div class="cell agent">${dot(p.team)} <span>${p.name}</span></div>
      <div class="cell team">${p.team}</div>
      <div class="cell trans">${p.transfer}</div>
    `);
  });
  const totalPages = Math.max(1, Math.ceil(list.length / PAGE_SIZE));
  footerInfo.textContent = `P√°gina ${Math.min(pageIndex+1,totalPages)} / ${totalPages}`;
}

/* ===== Overlay (rebases) ===== */
const overlay=document.getElementById('overlay');
const whoEl=document.getElementById('who');
const transEl=document.getElementById('trans');
function showCongrats(p){
  whoEl.textContent=p.name; transEl.textContent=`Transfer: ${p.transfer}`;
  whoEl.classList.remove('accent-fk','accent-rg');
  whoEl.classList.add(p.team==='Filekeepers'?'accent-fk':'accent-rg');
  overlay.style.display='grid'; spawnConfetti(); setTimeout(()=>overlay.style.display='none',2500);
}
function spawnConfetti(){
  document.querySelectorAll('.confetti').forEach(e=>e.remove());
  const colors=['#ffd166','#06d6a0','#118ab2','#ef476f','#ffffff','#19ff9a','#ff3a46'];
  for(let i=0;i<60;i++){
    const d=document.createElement('div'); d.className='confetti';
    const size=8+Math.random()*10, left=Math.random()*100, delay=Math.random()*0.2, dur=1.3+Math.random()*0.7;
    d.style.left=left+'%'; d.style.background=colors[Math.floor(Math.random()*colors.length)];
    d.style.width=size+'px'; d.style.height=(size*1.6)+'px'; d.style.animationDuration=dur+'s'; d.style.animationDelay=delay+'s';
    overlay.appendChild(d);
  }
}

/* ===== Google Sheets: rangos acotados ===== */
function encRange(name){ return encodeURIComponent("'"+name+"'"); }
/* FK: A2:A33 y C2:C33 ‚Äî RG: E2:E34 y G2:G34 */
async function fetchBatchFor(sheetName){
  const ranges=[
    `${encRange(sheetName)}!A2:A33`, `${encRange(sheetName)}!C2:C33`,
    `${encRange(sheetName)}!E2:E34`, `${encRange(sheetName)}!G2:G34`
  ];
  const url=`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values:batchGet?`+ranges.map(r=>`ranges=${r}`).join('&')+`&key=${API_KEY}`;
  const r=await fetch(url,{cache:"no-store"}); if(!r.ok) throw new Error(`HTTP ${r.status}`);
  return r.json();
}
const colToArr=vr=>!vr?.values?[]:vr.values.map(r=>String(r[0]||""));
function toPairs(names,transfers,team){
  const n=Math.max(names.length, transfers.length);
  const out=[];
  for(let i=0;i<n;i++){
    const nm=clean(names[i]||''); const t=parseInt((transfers[i]||'').trim())||0;
    if(nm!=='' || t!==0) out.push({name:nm||'Agente', transfer:t, team});
  } return out;
}

/* ===== Overtakes ===== */
let prevRank=new Map();
function detectOvertakes(sorted){
  const now=new Map(); sorted.forEach((p,i)=>now.set(p.name,i));
  const up=[]; sorted.forEach((p,i)=>{ if(prevRank.has(p.name)){ const b=prevRank.get(p.name); if(i<b) up.push(p); }});
  prevRank=now; return up;
}

/* ===== Estado global para paginaci√≥n ===== */
let ACTIVE_SHEET=null;
let ALL_DATA=[];         // lista global ordenada
let PAGE_INDEX=0;        // p√°gina actual

async function loadData(){
  const plan = getSheetNamePlan();
  const candidates = [plan.primary].concat(plan.fallback ? [plan.fallback] : []);
  for(const name of candidates){
    try{
      const j=await fetchBatchFor(name); const vr=j.valueRanges||[];
      const fk=toPairs(colToArr(vr[0]), colToArr(vr[1]), 'Filekeepers');
      const rg=toPairs(colToArr(vr[2]), colToArr(vr[3]), 'Rugrats');
      const all=fk.concat(rg).sort((a,b)=> b.transfer - a.transfer);
      if(all.length){
        ACTIVE_SHEET=name; ALL_DATA=all;
        sheetTag.textContent = `üìÖ Hoja: ${name}`;
        return {used:name, fkCount:fk.length, rgCount:rg.length};
      }
    }catch(e){ /* intenta siguiente */ }
  }
  throw new Error(`No hay datos en: ${candidates.join(', ')}`);
}

function renderCurrentPage(){
  renderRows(ALL_DATA, PAGE_INDEX);
}

async function refreshData(){
  try{
    const info=await loadData();
    const did=detectOvertakes(ALL_DATA);
    if(did.length) showCongrats(did.sort((a,b)=> b.transfer-a.transfer)[0]);
    // Si la p√°gina qued√≥ fuera de rango tras reordenar, la normalizamos
    const totalPages=Math.max(1, Math.ceil(ALL_DATA.length / PAGE_SIZE));
    PAGE_INDEX = Math.min(PAGE_INDEX, totalPages-1);
    renderCurrentPage();
    diag(`Actualizado ‚Ä¢ Sheet: ${ACTIVE_SHEET} ‚Ä¢ FK: ${info.fkCount} ¬∑ RG: ${info.rgCount} ‚Ä¢ Total: ${ALL_DATA.length} ‚Ä¢ P√°gina ${PAGE_INDEX+1}/${totalPages}`, 'ok');
  }catch(e){
    sheetTag.textContent = 'üìÖ Hoja: ‚Äî';
    diag('Error leyendo Sheets: '+(e.message||e), 'err');
  }
}

function nextPage(){
  const totalPages=Math.max(1, Math.ceil(ALL_DATA.length / PAGE_SIZE));
  PAGE_INDEX = (PAGE_INDEX + 1) % totalPages;
  renderCurrentPage();
  diag(`Cambio de p√°gina ‚Ä¢ ${PAGE_INDEX+1}/${totalPages}`, 'ok');
}

/* ===== Boot ===== */
(async function start(){
  diag('Determinando hoja y cargando datos‚Ä¶');
  await refreshData();
  setInterval(refreshData, REFRESH_MS);
  setInterval(nextPage, PAGE_MS);
})();
</script>
</body>
</html>
''')
