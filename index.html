from IPython.display import HTML

HTML(r"""
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<title>üèÅ Leaderboard üèÅ</title>
<style>
  :root{--from:#B4DB61;--to:#06BBA3;--ink:#0b1a13}
  html,body{
    margin:0;height:100%;
    background:#fff;
    color:var(--ink);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;
    overflow:hidden;
    display:flex;
    align-items:center;
    justify-content:center;
  }
  #board{
    width:92%;
    height:92%;
    max-width:1800px;
    border-radius:18px;
    padding:18px 20px;
    background:linear-gradient(135deg,var(--from),var(--to));
    box-shadow:0 0 50px rgba(0,0,0,.2);
    display:flex;
    flex-direction:column;
    gap:10px;
  }
  h2{margin:0;text-align:center;font-weight:900;letter-spacing:.3px;font-size:40px;}
  h2 .flag{filter:drop-shadow(0 1px 0 rgba(0,0,0,.15));}
  .chips{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin:-4px 0 2px}
  .chip{padding:4px 10px;border-radius:999px;background:rgba(255,255,255,.35);border:1px solid rgba(0,0,0,.08);font:700 14px/1 system-ui}

  /* Tabla: ahora table-layout:auto para que la columna Agent pueda expandirse */
  table{width:100%;border-collapse:collapse;font-size:17px;table-layout:auto}
  th,td{
    padding:6px 8px;text-align:center;
    background:rgba(255,255,255,.25);
    font-weight:600;
    white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
  }
  th{background:rgba(255,255,255,.45);text-transform:uppercase;font-size:15px;letter-spacing:.3px}
  tr:nth-child(even) td{background:rgba(255,255,255,.14)}
  #meta{display:flex;justify-content:space-between;align-items:center;font-weight:700;font-size:14px}

  /* Columna Agent: multilinea, sin truncar, alineada a la izquierda y m√°s ancha */
  .col-agent, th.col-agent{
    text-align:left !important;
    white-space:normal !important;
    overflow:visible !important;
    text-overflow:clip !important;
    font-weight:700;
    padding-left:12px;
    min-width:520px;    /* ajusta si lo necesitas (560‚Äì600 si hay nombres muy largos) */
    max-width:900px;
  }

  /* Overlay de felicitaci√≥n (solo por Today) */
  #overlay{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.45);z-index:999}
  #card{padding:40px 60px;border-radius:30px;background:linear-gradient(180deg,rgba(15,20,40,.95),rgba(15,20,40,.85));
        border:2px solid rgba(255,255,255,.25);color:#eaf3ff;box-shadow:0 0 80px rgba(0,0,0,.3);
        text-align:center;animation:pop .45s ease-out}
  #who{font:900 88px/1 system-ui;letter-spacing:.5px;text-shadow:0 3px 12px rgba(0,0,0,.5);margin-bottom:6px}
  #metaText{font:800 28px/1.3 system-ui;opacity:.95}
  #todayCount{font:900 54px/1 system-ui;margin-top:14px}
  .accent{color:#0cfaa1;text-shadow:0 0 22px rgba(25,255,154,.6)}
  @keyframes pop{from{transform:scale(.8);opacity:0}to{transform:scale(1);opacity:1}}
  .confetti{position:absolute;top:-10vh;width:14px;height:22px;opacity:0;animation:fall linear forwards}
  @keyframes fall{0%{transform:translateY(-10vh) rotate(0deg);opacity:0}10%{opacity:1}100%{transform:translateY(120vh) rotate(720deg);opacity:0}}
</style>
</head>
<body>
<div id="board">
  <h2><span class="flag">üèÅ</span> Leaderboard <span class="flag">üèÅ</span></h2>
  <div class="chips">
    <div id="chipWeekly" class="chip">Week: ‚Äî</div>
    <div id="chipDaily" class="chip">Daily: ‚Äî</div>
  </div>

  <!-- Encabezado: quitamos Agent ID, dejamos Agent como primera columna y legible -->
  <table id="tbl"><thead><tr>
    <th style="width:70px">#</th>
    <th class="col-agent">Agent</th>
    <th style="width:120px">Today</th>
    <th style="width:110px">Wed</th>
    <th style="width:110px">Thu</th>
    <th style="width:110px">Fri</th>
    <th style="width:110px">Sat</th>
    <th style="width:110px">Mon</th>
    <th style="width:110px">Tue</th>
    <th style="width:130px">Total</th>
  </tr></thead><tbody></tbody></table>

  <div id="meta">
    <div id="diag">Loading‚Ä¶</div>
    <div id="page">Page ‚Äî / ‚Äî</div>
  </div>
</div>

<!-- Overlay SOLO por incrementos en Today -->
<div id="overlay">
  <div id="card">
    <div id="who" class="accent">Agent</div>
    <div id="metaText">just passed ‚Äî today! üéâ</div>
    <div id="todayCount">Today: 0</div>
  </div>
</div>

<script>
// ======================= CONFIG =======================
const API_KEY        = "AIzaSyBWtgxYp3mPfjYVXeG_nYgE31lp4GicVFg";
const WEEKLY_SHEETID = "1pkNqNi_k5Ez1L1cYuvsT64m4oduGPJ4R7nLxesw6nrE";
const DAILY_ID_RAW   = "V1PtXIFUgb4Z3TWLNBll_HmLIiP6aeKe18rVIJClO8s";
const DAILY_IDS      = [DAILY_ID_RAW.startsWith("1")? DAILY_ID_RAW : ("1"+DAILY_ID_RAW), DAILY_ID_RAW];

const TIMEZONE       = "America/Tijuana";
const PAGE_SIZE      = 15;

// Timers
const PAGE_MS        = 45000;      // paginaci√≥n
const DAILY_REFRESH  = 15000;      // Today cada 15s
const WEEKLY_REFRESH = 5*60*1000;  // Weekly cada 5 min

// ======================= ESTADO =======================
let ALL = [];                 // datos ordenados por TOTAL del sheet
let PAGE_INDEX = 0;

let INITIALIZED_TODAY = false;
let PREV_TODAY = new Map();        // nameKey -> valor Today anterior
let PREV_TODAY_RANK = new Map();   // nameKey -> rank anterior por Today

// Cache
const Cache = {
  weekly: {at: 0, tab: null, data: null},
  daily : {at: 0, tab: null, data: null},
};

// ======================= UI helpers =======================
function diag(t, cls){ document.getElementById('diag').innerHTML = `<span class="${cls||''}">${t}</span>`; }
function setChipWeekly(t){ document.getElementById('chipWeekly').textContent = `Week: ${t}`; }
function setChipDaily(t){ document.getElementById('chipDaily').textContent = `Daily: ${t}`; }
function setPageText(cur, total){ document.getElementById('page').textContent = `Page ${cur} / ${total}`; }

// ======================= Tiempo local / Semana Wnn =======================
function getLocalDate(){
  const s = new Date().toLocaleString('en-US',{timeZone:TIMEZONE});
  return new Date(s);
}
function isoWeek(localDate){
  const d = new Date(Date.UTC(localDate.getFullYear(), localDate.getMonth(), localDate.getDate()));
  const dayNum = d.getUTCDay() || 7;
  d.setUTCDate(d.getUTCDate() + 4 - dayNum);
  const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
  const weekNo = Math.ceil((((d - yearStart)/86400000) + 1) / 7);
  return {week: weekNo, year: d.getUTCFullYear()};
}
function weeksInISOYear(y){
  const d = new Date(Date.UTC(y, 11, 31));
  const day = d.getUTCDay();
  return (day === 4 || (d.getUTCDate() === 31 && day === 3)) ? 53 : 52;
}
function computeWeeklyTabName(){
  const url = new URL(window.location.href);
  const override = url.searchParams.get('weeklyTab');
  if (override) return override;
  const local = getLocalDate();
  const hrs   = local.getHours();
  const dow   = local.getDay(); // 0..6, 4 = Thu
  const iw = isoWeek(local);
  let w = iw.week;
  const afterCut = (dow > 4) || (dow === 4 && hrs >= 14); // Jueves 14:00
  if (afterCut) { w += 1; const maxW = weeksInISOYear(iw.year); if (w > maxW){w=1;} }
  return `W${w}`;
}

// ======================= Normalizadores =======================
const emoji=/[\u{1F1E6}-\u{1F1FF}\u{1F300}-\u{1FAFF}\u{1F900}-\u{1F9FF}\u{2600}-\u{27BF}\u{FE0F}]/gu;
function normName(s){
  return (s||"").replace(emoji,"").normalize('NFD').replace(/[\u0300-\u036f]/g,"")
           .replace(/[^\x20-\x7E]/g,"").replace(/\s{2,}/g," ").trim().toUpperCase();
}
function normID(s){ return (s||"").toString().trim(); }

// ======================= Backoff seguro =======================
async function fetchSafeJSON(url, {tries=4, baseDelay=700} = {}){
  let lastErr;
  for (let i=0;i<tries;i++){
    try{
      const r = await fetch(url, {cache:"no-store"});
      if (r.ok) return await r.json();
      const text = await r.text();
      if (r.status===429 || (r.status>=500 && r.status<600)){
        const jitter = Math.random()*250;
        await new Promise(res=>setTimeout(res, baseDelay*Math.pow(2,i)+jitter));
        continue;
      }
      throw new Error(`HTTP ${r.status} ‚Ä¢ ${text.slice(0,180)}`);
    }catch(e){
      lastErr = e;
      const jitter = Math.random()*250;
      await new Promise(res=>setTimeout(res, baseDelay*Math.pow(2,i)+jitter));
    }
  }
  throw lastErr || new Error("fetchSafeJSON: unknown error");
}

// ======================= Readers (Weekly / Daily) =======================
async function readWeeklyTab(weeklyTab){
  const ranges = [
    `${weeklyTab}!A3:C96`, // Agent ID, Name
    `${weeklyTab}!D3:D96`, // Wed
    `${weeklyTab}!F3:F96`, // Thu
    `${weeklyTab}!H3:H96`, // Fri
    `${weeklyTab}!J3:J96`, // Sat
    `${weeklyTab}!L3:L96`, // Mon
    `${weeklyTab}!N3:N96`, // Tue
    `${weeklyTab}!O3:O96`  // Total (Sheet)
  ].map(encodeURIComponent);

  const url = `https://sheets.googleapis.com/v4/spreadsheets/${WEEKLY_SHEETID}/values:batchGet?`+
              ranges.map(r=>`ranges=${r}`).join("&")+
              `&valueRenderOption=UNFORMATTED_VALUE&key=${API_KEY}`;

  const j = await fetchSafeJSON(url);
  const vr = j.valueRanges||[];

  const base = vr[0]?.values||[];
  const toCol = v => (v?.values||[]).map(r=> (r[0]??"").toString().trim());
  const d = toCol(vr[1]), f = toCol(vr[2]), h = toCol(vr[3]),
        jv= toCol(vr[4]), l = toCol(vr[5]), n = toCol(vr[6]),
        oT = toCol(vr[7]);

  const len = Math.max(base.length, d.length, f.length, h.length, jv.length, l.length, n.length, oT.length);
  const out = [];
  for(let i=0;i<len;i++){
    const id   = normID(base[i]?.[0]??"");
    const name = (base[i]?.[1]??"").toString().trim();
    if(!id && !name) continue;
    out.push({
      id, idKey:id,
      name, nameKey:normName(name),
      wed:parseInt(d[i]||0), thu:parseInt(f[i]||0), fri:parseInt(h[i]||0),
      sat:parseInt(jv[i]||0), mon:parseInt(l[i]||0), tue:parseInt(n[i]||0),
      total:parseInt(oT[i]||0),
      today:0
    });
  }
  out.sort((a,b)=> (b.total||0) - (a.total||0)); // orden por TOTAL
  return out;
}

function fmtDailyTab(d){
  const m = new Intl.DateTimeFormat('en-US',{month:'short', timeZone:TIMEZONE}).format(d);
  const dd= new Intl.DateTimeFormat('en-US',{day:'2-digit', timeZone:TIMEZONE}).format(d);
  return `${m} ${dd}`;
}
function getDailyTabCandidates(){
  const url = new URL(window.location.href);
  const override = url.searchParams.get('dailyTab');
  if (override) return [override];
  const now = getLocalDate();
  const yday= new Date(now.getTime()-24*60*60*1000);
  return [fmtDailyTab(now), fmtDailyTab(yday)];
}

async function readDailyApproved(){
  const rangesFor = tab => ([
    `${tab}!A2:A34`, `${tab}!B2:B34`, `${tab}!C2:C34`, // FK: name, id?, approved
    `${tab}!E2:E34`, `${tab}!F2:F34`, `${tab}!G2:G34`  // RG: name, id?, approved
  ].map(encodeURIComponent));

  const tabs = getDailyTabCandidates();
  for(const id of DAILY_IDS){
    for(const tab of tabs){
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${id}/values:batchGet?`+
                  rangesFor(tab).map(r=>`ranges=${r}`).join("&")+
                  `&valueRenderOption=UNFORMATTED_VALUE&key=${API_KEY}`;
      try{
        const j = await fetchSafeJSON(url);
        const vr = j.valueRanges||[];
        const A = vr[0]?.values||[], B = vr[1]?.values||[], C = vr[2]?.values||[];
        const E = vr[3]?.values||[], F = vr[4]?.values||[], G = vr[5]?.values||[];

        const mapByName = new Map();
        const mapByID   = new Map();
        function addPair(nmCell, idCell, valCell){
          const nm = (nmCell?.[0]??"").toString();
          const id = (idCell?.[0]??"").toString().trim();
          const v  = parseInt((valCell?.[0]??0))||0;
          if(nm.trim()){ const nk = normName(nm); mapByName.set(nk, (mapByName.get(nk)||0) + v); }
          if(id){ mapByID.set(id, (mapByID.get(id)||0) + v); }
        }
        const rowsFK = Math.max(A.length,B.length,C.length);
        for(let i=0;i<rowsFK;i++) addPair(A[i],B[i],C[i]);
        const rowsRG = Math.max(E.length,F.length,G.length);
        for(let i=0;i<rowsRG;i++) addPair(E[i],F[i],G[i]);

        return {id, tab, mapByName, mapByID};
      }catch(e){
        // probar√° siguiente combinaci√≥n
      }
    }
  }
  return {id: DAILY_IDS[0], tab: tabs[0], mapByName:new Map(), mapByID:new Map()};
}

// ======================= Cache wrappers =======================
function isFresh(obj, ttlMs){ return (Date.now() - obj.at) < ttlMs; }

async function getWeeklyCached(weeklyTab, ttlMs=WEEKLY_REFRESH){
  if (Cache.weekly.data && Cache.weekly.tab===weeklyTab && isFresh(Cache.weekly, ttlMs)){
    return Cache.weekly.data;
  }
  const data = await readWeeklyTab(weeklyTab);
  Cache.weekly = {at: Date.now(), tab: weeklyTab, data};
  return data;
}

async function getDailyCached(ttlMs=DAILY_REFRESH){
  if (Cache.daily.data && isFresh(Cache.daily, ttlMs)){
    return Cache.daily.data;
  }
  const data = await readDailyApproved();
  Cache.daily = {at: Date.now(), tab: data.tab, data};
  return data;
}

// ======================= Render & Overlay =======================
function renderPage(list, pageIndex){
  const tbody = document.querySelector("#tbl tbody");
  tbody.innerHTML = "";
  const start = pageIndex * PAGE_SIZE;
  const page  = list.slice(start, start + PAGE_SIZE);
  page.forEach((p,i)=>{
    tbody.insertAdjacentHTML("beforeend", `
      <tr>
        <td>${start + i + 1}</td>
        <td class="col-agent" title="${p.name}">${p.name}</td>
        <td>${p.today||0}</td>
        <td>${p.wed||0}</td>
        <td>${p.thu||0}</td>
        <td>${p.fri||0}</td>
        <td>${p.sat||0}</td>
        <td>${p.mon||0}</td>
        <td>${p.tue||0}</td>
        <td><b>${p.total||0}</b></td>
      </tr>
    `);
  });
  const totalPages = Math.max(1, Math.ceil(list.length / PAGE_SIZE));
  setPageText(PAGE_INDEX+1, totalPages);
}

// Overlay (solo por Today)
const overlay = document.getElementById('overlay');
const whoEl = document.getElementById('who');
const metaTextEl = document.getElementById('metaText');
const todayEl = document.getElementById('todayCount');

function spawnConfetti(){
  document.querySelectorAll('.confetti').forEach(e=>e.remove());
  const colors=['#ffd166','#06d6a0','#118ab2','#ef476f','#ffffff','#19ff9a','#ff3a46'];
  for(let i=0;i<80;i++){
    const d=document.createElement('div'); d.className='confetti';
    const size=8+Math.random()*10, left=Math.random()*100, delay=Math.random()*0.25, dur=1.2+Math.random()*0.9;
    d.style.left=left+'%'; d.style.background=colors[Math.floor(Math.random()*colors.length)];
    d.style.width=size+'px'; d.style.height=(size*1.6)+'px'; d.style.animationDuration=dur+'s'; d.style.animationDelay=delay+'s';
    overlay.appendChild(d);
  }
}
function showCongratsToday(winnerName, todayCount, passedName){
  whoEl.textContent = winnerName || 'Agent';
  metaTextEl.textContent = passedName ? `just passed ${passedName} today! üéâ` : `is climbing today! üéâ`;
  todayEl.textContent = `Today: ${todayCount}`;
  overlay.style.display='grid';
  spawnConfetti();
  setTimeout(()=> overlay.style.display='none', 2600);
}

function buildTodayRanking(list){
  const copy = list.map(p => ({nameKey:p.nameKey, name:p.name, today:p.today||0}));
  copy.sort((a,b)=> (b.today||0) - (a.today||0));
  const rankMap = new Map(); const order = [];
  copy.forEach((p,i)=>{ rankMap.set(p.nameKey, i); order[i]=p.nameKey; });
  return {rankMap, order};
}
function detectTodayEvents(list){
  const {rankMap: CUR_RANK, order: CUR_ORDER} = buildTodayRanking(list);
  const events = [];
  list.forEach(p=>{
    const key = p.nameKey;
    const prevCount = PREV_TODAY.get(key) ?? 0;
    const currCount = p.today || 0;
    if (currCount > prevCount){
      const prevRank = PREV_TODAY_RANK.has(key) ? PREV_TODAY_RANK.get(key) : Number.POSITIVE_INFINITY;
      const currRank = CUR_RANK.get(key);
      let passedName = null;
      if (currRank < prevRank){
        const behindIdx = currRank + 1;
        if (behindIdx < CUR_ORDER.length){
          const behindKey = CUR_ORDER[behindIdx];
          const behind = list.find(x => x.nameKey === behindKey);
          if (behind) passedName = behind.name;
        }
      }
      events.push({ winnerName: p.name, today: currCount, passedName });
    }
  });
  // snapshot
  PREV_TODAY.clear(); PREV_TODAY_RANK.clear();
  list.forEach(p => { PREV_TODAY.set(p.nameKey, p.today||0); });
  const {rankMap} = buildTodayRanking(list);
  list.forEach(p => { PREV_TODAY_RANK.set(p.nameKey, rankMap.get(p.nameKey)); });
  if (!events.length) return null;
  events.sort((a,b)=> (b.today - a.today));
  return events[0];
}

// ======================= Loops =======================
function isFresh(obj, ttlMs){ return (Date.now() - obj.at) < ttlMs; }

async function getWeeklyCached(weeklyTab, ttlMs=WEEKLY_REFRESH){
  if (Cache.weekly.data && Cache.weekly.tab===weeklyTab && isFresh(Cache.weekly, ttlMs)) return Cache.weekly.data;
  const data = await readWeeklyTab(weeklyTab);
  Cache.weekly = {at: Date.now(), tab: weeklyTab, data};
  return data;
}
async function getDailyCached(ttlMs=DAILY_REFRESH){
  if (Cache.daily.data && isFresh(Cache.daily, ttlMs)) return Cache.daily.data;
  const data = await readDailyApproved();
  Cache.daily = {at: Date.now(), tab: data.tab, data};
  return data;
}

async function refreshWeekly(){
  try{
    const weeklyTab = computeWeeklyTabName();
    setChipWeekly(weeklyTab);
    ALL = await getWeeklyCached(weeklyTab, WEEKLY_REFRESH); // ordenado por total
    diag(`Weekly OK (${weeklyTab}) ‚Ä¢ ${ALL.length} agents`,'ok');
  }catch(e){ diag('Weekly error: '+(e.message||e),'err'); }
}

async function refreshDaily(){
  try{
    const {id, tab, mapByName, mapByID} = await getDailyCached(DAILY_REFRESH);
    setChipDaily(tab);
    if (!ALL.length){ await refreshWeekly(); if(!ALL.length) return; }
    ALL.forEach(p=>{
      const vID = mapByID.get(p.idKey);
      const vNM = mapByName.get(p.nameKey);
      p.today = (typeof vID==="number" && !Number.isNaN(vID)) ? vID :
                (typeof vNM==="number" && !Number.isNaN(vNM)) ? vNM : 0;
    });
    let event = null;
    if (INITIALIZED_TODAY){ event = detectTodayEvents(ALL); }
    else {
      const {rankMap} = buildTodayRanking(ALL);
      ALL.forEach(p => { PREV_TODAY.set(p.nameKey, p.today||0); PREV_TODAY_RANK.set(p.nameKey, rankMap.get(p.nameKey)); });
      INITIALIZED_TODAY = true;
    }
    if (event) showCongratsToday(event.winnerName, event.today, event.passedName);
    diag(`Daily OK (${tab})`,'ok');
  }catch(e){ diag('Daily error: '+(e.message||e),'err'); }
}

function rotatePage(){
  if (!ALL.length) return;
  const totalPages = Math.max(1, Math.ceil(ALL.length / PAGE_SIZE));
  PAGE_INDEX = PAGE_INDEX % totalPages;
  renderPage(ALL, PAGE_INDEX);
  setPageText(PAGE_INDEX+1, totalPages);
  PAGE_INDEX = (PAGE_INDEX + 1) % totalPages;
}

// ======================= Arranque =======================
(async function start(){
  await refreshWeekly();  // primer weekly
  await refreshDaily();   // primer daily
  rotatePage();           // primera p√°gina

  setInterval(refreshWeekly, WEEKLY_REFRESH); // 5 min
  setInterval(refreshDaily,  DAILY_REFRESH);  // 15 s
  setInterval(rotatePage,    PAGE_MS);        // 45 s
})();
</script>
</body>
</html>
""")
