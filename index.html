<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<title>üèÅ Leaderboard üèÅ</title>
<style>
  :root{
    --vh: 1vh;
    --fs-base: calc(1.8*var(--vh));
    --fs-h2:   calc(4.0*var(--vh));
    --fs-th:   calc(1.6*var(--vh));
    --fs-td:   calc(1.7*var(--vh));
    --pad-cell: calc(0.6*var(--vh));
    --from:#B4DB61; --to:#06BBA3; --ink:#0b1a13;
  }
  html,body{ margin:0;height:100%;width:100%; background:#fff;color:var(--ink); font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif; overflow:hidden; }
  #board{ width:100vw;height:100vh; padding:calc(1.5*var(--vh)) calc(1.8*var(--vh)); box-sizing:border-box;
          background:linear-gradient(135deg,var(--from),var(--to)); display:flex;flex-direction:column;gap:calc(1.0*var(--vh)); }
  h2{ margin:0;text-align:center;font-weight:900;letter-spacing:.3px; font-size:var(--fs-h2); line-height:1.1; }
  h2 .flag{filter:drop-shadow(0 1px 0 rgba(0,0,0,.12));}
  .chips{ display:flex;gap:calc(.8*var(--vh));flex-wrap:wrap; justify-content:center;margin-top:calc(-.4*var(--vh)); }
  .chip{ padding:calc(.4*var(--vh)) calc(.8*var(--vh)); border-radius:999px;background:rgba(255,255,255,.38);
         border:1px solid rgba(0,0,0,.08); font-weight:700;font-size:calc(1.5*var(--vh)); }
  .table-wrap{ flex:1; min-height:0; }
  table{ width:100%; height:100%; border-collapse:collapse; table-layout:fixed; font-size:var(--fs-td); }
  thead th{ position:sticky; top:0; z-index:2; background:rgba(255,255,255,.50); text-transform:uppercase; letter-spacing:.3px; font-size:var(--fs-th); font-weight:800; }
  th,td{ padding:var(--pad-cell) calc(0.9*var(--vh)); text-align:center; background:rgba(255,255,255,.26); font-weight:600; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  tbody tr:nth-child(even) td{ background:rgba(255,255,255,.16); }
  th.col-rank, td.col-rank { width:7%; }
  th.col-agent,td.col-agent{ width:28%; }
  th.col-today,td.col-today{ width:9%; }
  th.col-day,  td.col-day  { width:8%; }
  th.col-total,td.col-total{ width:11%; }
  .col-agent, th.col-agent{ text-align:left !important; white-space:normal !important; overflow:visible !important;
                             text-overflow:clip !important; padding-left:calc(1.0*var(--vh)); font-weight:800; }
  #meta{ display:flex;justify-content:space-between;align-items:center; font-weight:700;font-size:calc(1.5*var(--vh)); }
  .ok{color:#157f3b}.err{color:#b00020}
  #overlay{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.45);z-index:999}
  #card{ padding:calc(4*var(--vh)) calc(6*var(--vh)); border-radius:calc(3*var(--vh));
         background:linear-gradient(180deg,rgba(15,20,40,.95),rgba(15,20,40,.85)); border:2px solid rgba(255,255,255,.25); color:#eaf3ff;
         text-align:center; animation:pop .45s ease-out; box-shadow:0 0 calc(8*var(--vh)) rgba(0,0,0,.3); }
  #who{font:900 calc(8.8*var(--vh))/1 system-ui;letter-spacing:.5px;text-shadow:0 3px 12px rgba(0,0,0,.5);margin-bottom:calc(.6*var(--vh))}
  #metaText{font:800 calc(2.8*var(--vh))/1.3 system-ui;opacity:.95}
  #todayCount{font:900 calc(5.4*var(--vh))/1 system-ui;margin-top:calc(1.2*var(--vh))}
  .accent{color:#0cfaa1;text-shadow:0 0 22px rgba(25,255,154,.6)}
  @keyframes pop{from{transform:scale(.8);opacity:0}to{transform:scale(1);opacity:1}}
  .confetti{position:absolute;top:-10vh;width:14px;height:22px;opacity:0;animation:fall 10s linear forwards}
  @keyframes fall{0%{transform:translateY(-10vh) rotate(0deg);opacity:0}10%{opacity:1}100%{transform:translateY(120vh) rotate(720deg);opacity:0}}
</style>
</head>
<body>
<div id="board">
  <h2><span class="flag">üèÅ</span> Leaderboard <span class="flag">üèÅ</span></h2>
  <div class="chips">
    <div id="chipWeekly" class="chip">Week: ‚Äî</div>
    <div id="chipDaily" class="chip">Daily: ‚Äî</div>
  </div>
  <div class="table-wrap">
    <table id="tbl">
      <thead>
        <tr>
          <th class="col-rank">#</th>
          <th class="col-agent">Agent</th>
          <th class="col-today">Today</th>
          <th class="col-day">Wed</th>
          <th class="col-day">Thu</th>
          <th class="col-day">Fri</th>
          <th class="col-day">Sat</th>
          <th class="col-day">Mon</th>
          <th class="col-day">Tue</th>
          <th class="col-total">Total</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
  <div id="meta">
    <div id="diag">Loading‚Ä¶</div>
    <div id="page">Page ‚Äî / ‚Äî</div>
  </div>
</div>
<div id="overlay">
  <div id="card">
    <div id="who" class="accent">Agent</div>
    <div id="metaText">just passed ‚Äî today! üéâ</div>
    <div id="todayCount">Today: 0</div>
  </div>
</div>
<script>
function setVHVar(){ const vh=window.innerHeight*0.01; document.documentElement.style.setProperty('--vh', vh+'px'); }
setVHVar(); window.addEventListener('resize', setVHVar);

const API_KEY        = "AIzaSyBWtgxYp3mPfjYVXeG_nYgE31lp4GicVFg";
const WEEKLY_SHEETID = "1pkNqNi_k5Ez1L1cYuvsT64m4oduGPJ4R7nLxesw6nrE";
const DAILY_ID_RAW   = "V1PtXIFUgb4Z3TWLNBll_HmLIiP6aeKe18rVIJClO8s";
const DAILY_IDS      = [DAILY_ID_RAW.startsWith("1")? DAILY_ID_RAW : ("1"+DAILY_ID_RAW), DAILY_ID_RAW];

const TIMEZONE       = "America/Tijuana";
const PAGE_SIZE      = 15;
const PAGE_MS        = 45000;
const DAILY_REFRESH  = 15000;
const WEEKLY_REFRESH = 5*60*1000;

let ALL=[]; let PAGE_INDEX=0; let INITIALIZED_TODAY=false;
let PREV_TODAY=new Map(); let PREV_TODAY_RANK=new Map();

const Cache={ weekly:{at:0,tab:null,data:null}, daily:{at:0,tab:null,data:null} };

function diag(t, cls){ document.getElementById('diag').innerHTML = `<span class="${cls||''}">${t}</span>`; }
function setChipWeekly(t){ document.getElementById('chipWeekly').textContent = `Week: ${t}`; }
function setChipDaily(t){ document.getElementById('chipDaily').textContent = `Daily: ${t}`; }
function setPageText(cur, total){ document.getElementById('page').textContent = `Page ${cur} / ${total}`; }

function getLocalDate(){ const s=new Date().toLocaleString('en-US',{timeZone:TIMEZONE}); return new Date(s); }
function isoWeek(d){ const x=new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())); const n=x.getUTCDay()||7; x.setUTCDate(x.getUTCDate()+4-n); const y=new Date(Date.UTC(x.getUTCFullYear(),0,1)); return {week:Math.ceil((((x-y)/86400000)+1)/7), year:x.getUTCFullYear()}; }
function weeksInISOYear(y){ const d=new Date(Date.UTC(y,11,31)); const day=d.getUTCDay(); return (day===4 || (d.getUTCDate()===31 && day===3))?53:52; }
function computeWeeklyTabName(){
  const url=new URL(window.location.href); const override=url.searchParams.get('weeklyTab'); if(override) return override;
  const local=getLocalDate(); const hrs=local.getHours(); const dow=local.getDay();
  const iw=isoWeek(local); let w=iw.week;
  const afterCut=(dow>4)||(dow===4&&hrs>=14); if(afterCut){ w++; const mx=weeksInISOYear(iw.year); if(w>mx){w=1;} }
  return `W${w}`;
}
const emoji=/[\u{1F1E6}-\u{1F1FF}\u{1F300}-\u{1FAFF}\u{1F900}-\u{1F9FF}\u{2600}-\u{27BF}\u{FE0F}]/gu;
function normName(s){ return (s||"").replace(emoji,"").normalize('NFD').replace(/[\u0300-\u036f]/g,"").replace(/[^\x20-\x7E]/g,"").replace(/\s{2,}/g," ").trim().toUpperCase(); }
function normID(s){ return (s||"").toString().trim(); }

async function fetchSafeJSON(url, {tries=4, baseDelay=700}={}){
  let lastErr;
  for(let i=0;i<tries;i++){
    try{
      const r=await fetch(url,{cache:'no-store'});
      if(r.ok) return await r.json();
      const text=await r.text();
      if(r.status===429 || (r.status>=500 && r.status<600)){
        const jitter=Math.random()*250; await new Promise(res=>setTimeout(res, baseDelay*Math.pow(2,i)+jitter)); continue;
      }
      throw new Error(`HTTP ${r.status} ‚Ä¢ ${text.slice(0,180)}`);
    }catch(e){
      lastErr=e; const jitter=Math.random()*250; await new Promise(res=>setTimeout(res, baseDelay*Math.pow(2,i)+jitter));
    }
  }
  throw lastErr || new Error('fetchSafeJSON: unknown');
}

async function readWeeklyTab(weeklyTab){
  const ranges=[`${weeklyTab}!A3:C96`,`${weeklyTab}!D3:D96`,`${weeklyTab}!F3:F96`,`${weeklyTab}!H3:H96`,`${weeklyTab}!J3:J96`,`${weeklyTab}!L3:L96`,`${weeklyTab}!N3:N96`,`${weeklyTab}!O3:O96`]
    .map(encodeURIComponent);
  const url=`https://sheets.googleapis.com/v4/spreadsheets/${WEEKLY_SHEETID}/values:batchGet?`+ranges.map(r=>`ranges=${r}`).join("&")+`&valueRenderOption=UNFORMATTED_VALUE&key=${API_KEY}`;
  const j=await fetchSafeJSON(url); const vr=j.valueRanges||[];
  const base=vr[0]?.values||[]; const toCol=v=>(v?.values||[]).map(r=>(r[0]??"").toString().trim());
  const d=toCol(vr[1]), f=toCol(vr[2]), h=toCol(vr[3]), jv=toCol(vr[4]), l=toCol(vr[5]), n=toCol(vr[6]), oT=toCol(vr[7]);
  const len=Math.max(base.length,d.length,f.length,h.length,jv.length,l.length,n.length,oT.length);
  const out=[];
  for(let i=0;i<len;i++){
    const id=normID(base[i]?.[0]??""); const name=(base[i]?.[1]??"").toString().trim();
    if(!id && !name) continue;
    out.push({ id,idKey:id, name, nameKey:normName(name),
      wed:parseInt(d[i]||0), thu:parseInt(f[i]||0), fri:parseInt(h[i]||0),
      sat:parseInt(jv[i]||0), mon:parseInt(l[i]||0), tue:parseInt(n[i]||0),
      total:parseInt(oT[i]||0), today:0 });
  }
  out.sort((a,b)=>(b.total||0)-(a.total||0));
  return out;
}

function fmtDailyTab(dt){ const m=new Intl.DateTimeFormat('en-US',{month:'short',timeZone:TIMEZONE}).format(dt); const dd=new Intl.DateTimeFormat('en-US',{day:'2-digit',timeZone:TIMEZONE}).format(dt); return `${m} ${dd}`; }
function getDailyTabCandidates(){ const url=new URL(window.location.href); const o=url.searchParams.get('dailyTab'); if(o) return [o]; const now=getLocalDate(); const y=new Date(now.getTime()-86400000); return [fmtDailyTab(now), fmtDailyTab(y)]; }

async function readDailyApproved(){
  const rangesFor=tab=>([`${tab}!A2:A34`,`${tab}!B2:B34`,`${tab}!C2:C34`,`${tab}!E2:E34`,`${tab}!F2:F34`,`${tab}!G2:G34`].map(encodeURIComponent));
  const tabs=getDailyTabCandidates();
  for(const id of DAILY_IDS){
    for(const tab of tabs){
      const url=`https://sheets.googleapis.com/v4/spreadsheets/${id}/values:batchGet?`+rangesFor(tab).map(r=>`ranges=${r}`).join("&")+`&valueRenderOption=UNFORMATTED_VALUE&key=${API_KEY}`;
      try{
        const j=await fetchSafeJSON(url); const vr=j.valueRanges||[];
        const A=vr[0]?.values||[], B=vr[1]?.values||[], C=vr[2]?.values||[];
        const E=vr[3]?.values||[], F=vr[4]?.values||[], G=vr[5]?.values||[];
        const mapByName=new Map(); const mapByID=new Map();
        function addPair(nmCell,idCell,valCell){
          const nm=(nmCell?.[0]??"").toString(); const id=(idCell?.[0]??"").toString().trim(); const v=parseInt((valCell?.[0]??0))||0;
          if(nm.trim()){ const nk=normName(nm); mapByName.set(nk,(mapByName.get(nk)||0)+v); }
          if(id){ mapByID.set(id,(mapByID.get(id)||0)+v); }
        }
        const rowsFK=Math.max(A.length,B.length,C.length); for(let i=0;i<rowsFK;i++) addPair(A[i],B[i],C[i]);
        const rowsRG=Math.max(E.length,F.length,G.length); for(let i=0;i<rowsRG;i++) addPair(E[i],F[i],G[i]);
        return {id, tab, mapByName, mapByID};
      }catch(e){ /* try next candidate */ }
    }
  }
  return {id:DAILY_IDS[0], tab:tabs[0], mapByName:new Map(), mapByID:new Map()};
}

function isFresh(obj,ttl){ return (Date.now()-obj.at)<ttl; }
async function getWeeklyCached(weeklyTab, ttl=WEEKLY_REFRESH){
  if(Cache.weekly.data && Cache.weekly.tab===weeklyTab && isFresh(Cache.weekly, ttl)) return Cache.weekly.data;
  const data=await readWeeklyTab(weeklyTab); Cache.weekly={at:Date.now(),tab:weeklyTab,data}; return data;
}
async function getDailyCached(ttl=DAILY_REFRESH){
  if(Cache.daily.data && isFresh(Cache.daily, ttl)) return Cache.daily.data;
  const data=await readDailyApproved(); Cache.daily={at:Date.now(),tab:data.tab,data}; return data;
}

function renderPage(list, pageIndex){
  const tbody=document.querySelector("#tbl tbody");
  tbody.innerHTML="";
  const start=pageIndex*PAGE_SIZE;
  const page=list.slice(start, start+PAGE_SIZE);
  page.forEach((p,i)=>{
    tbody.insertAdjacentHTML("beforeend", `
      <tr>
        <td class="col-rank">${start+i+1}</td>
        <td class="col-agent" title="${p.name}">${p.name}</td>
        <td class="col-today">${p.today||0}</td>
        <td class="col-day">${p.wed||0}</td>
        <td class="col-day">${p.thu||0}</td>
        <td class="col-day">${p.fri||0}</td>
        <td class="col-day">${p.sat||0}</td>
        <td class="col-day">${p.mon||0}</td>
        <td class="col-day">${p.tue||0}</td>
        <td class="col-total"><b>${p.total||0}</b></td>
      </tr>
    `);
  });
  const totalPages=Math.max(1, Math.ceil(list.length/PAGE_SIZE));
  setPageText(Math.min(pageIndex+1,totalPages), totalPages);
}

const overlay=document.getElementById('overlay');
const whoEl=document.getElementById('who');
const metaTextEl=document.getElementById('metaText');
const todayEl=document.getElementById('todayCount');

function spawnConfetti(){
  document.querySelectorAll('.confetti').forEach(e=>e.remove());
  const colors=['#ffd166','#06d6a0','#118ab2','#ef476f','#ffffff','#19ff9a','#ff3a46'];
  for(let i=0;i<140;i++){
    const d=document.createElement('div'); d.className='confetti';
    const size=6+Math.random()*14, left=Math.random()*100, delay=Math.random()*0.8, dur=8+Math.random()*6;
    d.style.left=left+'vw'; d.style.background=colors[Math.floor(Math.random()*colors.length)];
    d.style.width=size+'px'; d.style.height=(size*1.6)+'px';
    d.style.animationDuration=dur+'s'; d.style.animationDelay=delay+'s';
    d.style.transform=`translateY(-10vh) rotate(${(Math.random()*360).toFixed(1)}deg)`;
    overlay.appendChild(d);
    d.addEventListener('animationend', ()=>d.remove());
  }
}
function showCongratsToday(winnerName, todayCount, passedName){
  whoEl.textContent=winnerName||'Agent';
  metaTextEl.textContent=passedName?`just passed ${passedName} today! üéâ`:`is climbing today! üéâ`;
  todayEl.textContent=`Today: ${todayCount}`;
  overlay.style.display='grid'; spawnConfetti();
  setTimeout(()=> overlay.style.display='none', 10000);
}
function buildTodayRanking(list){
  const copy=list.map(p=>({nameKey:p.nameKey,name:p.name,today:p.today||0}));
  copy.sort((a,b)=>(b.today||0)-(a.today||0));
  const rankMap=new Map(); const order=[];
  copy.forEach((p,i)=>{ rankMap.set(p.nameKey,i); order[i]=p.nameKey; });
  return {rankMap, order};
}
function detectTodayEvents(list){
  const {rankMap:CUR_RANK, order:CUR_ORDER}=buildTodayRanking(list);
  const events=[];
  list.forEach(p=>{
    const key=p.nameKey, prev=PREV_TODAY.get(key)??0, cur=p.today||0;
    if(cur>prev){
      const prevRank=PREV_TODAY_RANK.has(key)?PREV_TODAY_RANK.get(key):Number.POSITIVE_INFINITY;
      const curRank=CUR_RANK.get(key);
      let passed=null;
      if(curRank<prevRank){
        const behindIdx=curRank+1;
        if(behindIdx<CUR_ORDER.length){
          const behindKey=CUR_ORDER[behindIdx];
          const b=list.find(x=>x.nameKey===behindKey);
          if(b) passed=b.name;
        }
      }
      events.push({winnerName:p.name,today:cur,passedName:passed});
    }
  });
  PREV_TODAY.clear(); PREV_TODAY_RANK.clear();
  list.forEach(p=>PREV_TODAY.set(p.nameKey,p.today||0));
  const {rankMap}=buildTodayRanking(list); list.forEach(p=>PREV_TODAY_RANK.set(p.nameKey,rankMap.get(p.nameKey)));
  if(!events.length) return null; events.sort((a,b)=>b.today-a.today); return events[0];
}

async function refreshWeekly(){
  try{
    const weeklyTab=computeWeeklyTabName(); setChipWeekly(weeklyTab);
    ALL=await getWeeklyCached(weeklyTab,WEEKLY_REFRESH);
    diag(`Weekly OK (${weeklyTab}) ‚Ä¢ ${ALL.length} agents`,'ok');
  }catch(e){ diag('Weekly error: '+(e.message||e),'err'); }
}
async function refreshDaily(){
  try{
    const {id,tab,mapByName,mapByID}=await getDailyCached(DAILY_REFRESH);
    setChipDaily(tab);
    if(!ALL.length){ await refreshWeekly(); if(!ALL.length) return; }
    ALL.forEach(p=>{
      const vID=mapByID.get(p.idKey), vNM=mapByName.get(p.nameKey);
      p.today = (typeof vID==='number' && !Number.isNaN(vID)) ? vID :
                (typeof vNM==='number' && !Number.isNaN(vNM)) ? vNM : 0;
    });
    let event=null;
    if(INITIALIZED_TODAY){ event=detectTodayEvents(ALL); }
    else {
      const {rankMap}=buildTodayRanking(ALL);
      ALL.forEach(p=>{ PREV_TODAY.set(p.nameKey,p.today||0); PREV_TODAY_RANK.set(p.nameKey,rankMap.get(p.nameKey)); });
      INITIALIZED_TODAY=true;
    }
    if(event) showCongratsToday(event.winnerName,event.today,event.passedName);
    diag(`Daily OK (${tab})`,'ok');
  }catch(e){ diag('Daily error: '+(e.message||e),'err'); }
}
function rotatePage(){
  if(!ALL.length) return;
  const totalPages=Math.max(1, Math.ceil(ALL.length/PAGE_SIZE));
  PAGE_INDEX=PAGE_INDEX%totalPages; renderPage(ALL,PAGE_INDEX);
  setPageText(PAGE_INDEX+1,totalPages);
  PAGE_INDEX=(PAGE_INDEX+1)%totalPages;
}

(async function start(){
  await refreshWeekly();
  await refreshDaily();
  rotatePage();
  setInterval(refreshWeekly, WEEKLY_REFRESH);
  setInterval(refreshDaily,  DAILY_REFRESH);
  setInterval(rotatePage,    PAGE_MS);
})();
</script>
</body>
</html>
