from IPython.display import HTML
HTML(r'''
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Endless Dashboard Transfers ‚Äî v11 (Sheet por d√≠a)</title>
<style>
  :root{ --bg:#fff; --text:#0b1a13; --panelFrom:#B4DB61; --panelTo:#06BBA3; --fk:#19ff9a; --rg:#ff3a46; }
  html,body{margin:0;height:100%;background:var(--bg);overflow:hidden}
  #wrap{position:fixed;inset:0;display:grid;place-items:center;background:var(--bg)}
  #stage{width:min(100vw,177.78vh);height:calc(min(100vw,177.78vh)/16*9);position:relative;color:var(--text);
         font:600 14px/1.35 system-ui,-apple-system,Segoe UI,Roboto,sans-serif}

  /* Header */
  #header{position:absolute;left:20px;top:20px;right:20px;display:flex;align-items:center;justify-content:space-between;gap:12px}
  .brand{display:flex;gap:10px;align-items:center;background:rgba(0,0,0,.06);padding:10px 14px;border-radius:12px;border:1px solid rgba(0,0,0,.08)}
  .chip{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;font-weight:700;background:rgba(0,0,0,.06);border:1px solid rgba(0,0,0,.08)}
  .dot{width:10px;height:10px;border-radius:50%}
  .fk{background:var(--fk);box-shadow:0 0 6px var(--fk)}
  .rg{background:var(--rg);box-shadow:0 0 6px var(--rg)}
  #sheetTag{font-weight:800}

  /* Panel (degradado B4DB61 -> 06BBA3) */
  #board{position:absolute;left:20px;right:20px;top:84px;bottom:20px;background:linear-gradient(135deg,var(--panelFrom),var(--panelTo));
         border:1px solid rgba(0,0,0,.12);border-radius:16px;padding:16px 16px 12px 16px;box-shadow:0 8px 28px rgba(0,0,0,.12)}
  #board h3{margin:0 0 12px 0;font:800 20px/1.2 system-ui;letter-spacing:.2px;color:#0a1a10}
  .grid{display:grid;grid-template-columns:64px 1fr 160px 140px;gap:6px;align-items:center}
  .head{opacity:.9;font-weight:800;text-transform:uppercase;letter-spacing:.6px;font-size:13px}
  .cell{padding:10px 12px;background:rgba(255,255,255,.18);border-radius:10px}
  .rank{text-align:right;opacity:.9}
  .agent{display:flex;align-items:center;gap:10px;overflow:hidden;white-space:nowrap;text-overflow:ellipsis}
  .team{opacity:.95}
  .trans{text-align:right;font-weight:900}

  /* Overlay (rebase) */
  #overlay{position:absolute;inset:0;display:none;place-items:center;background:rgba(0,0,0,.35)}
  #card{padding:28px 40px;border-radius:20px;background:linear-gradient(180deg,rgba(15,20,40,.92),rgba(15,20,40,.78));
        border:1px solid rgba(255,255,255,.25);color:#eaf3ff;box-shadow:0 0 60px rgba(0,0,0,.25);text-align:center;animation:pop .5s ease-out}
  #who{font:900 72px/1.05 system-ui;letter-spacing:.5px;text-shadow:0 2px 10px rgba(0,0,0,.35)}
  #meta{font:700 28px/1.25 system-ui;opacity:.9;margin-top:6px}
  #trans{font:900 54px/1.05 system-ui;margin-top:12px}
  .accent-fk{color:#0cfaa1;text-shadow:0 0 22px rgba(25,255,154,.6)}
  .accent-rg{color:#ff5151;text-shadow:0 0 22px rgba(255,81,81,.6)}
  @keyframes pop{from{transform:scale(.9);opacity:0}to{transform:scale(1);opacity:1}}
  .confetti{position:absolute;top:-10vh;width:12px;height:18px;opacity:0;animation:fall linear forwards}
  @keyframes fall{0%{transform:translateY(-10vh) rotate(0deg);opacity:0}10%{opacity:1}100%{transform:translateY(120vh) rotate(720deg);opacity:0}}

  /* Diag */
  #diag{position:absolute;left:20px;bottom:20px;color:#0b1a13;background:rgba(0,0,0,.06);padding:8px 10px;border-radius:10px;border:1px solid rgba(0,0,0,.08);font:13px/1.3 system-ui;white-space:pre-wrap;max-width:70ch}
  .ok{color:#157f3b}.warn{color:#a86b00}.err{color:#b00020}
</style>
</head>
<body>
<div id="wrap"><div id="stage">

  <div id="header">
    <div class="brand">
      <div id="sheetTag">üìÖ Hoja: ‚Äî</div>
      <div class="chip"><span class="dot fk"></span>Filekeepers</div>
      <div class="chip"><span class="dot rg"></span>Rugrats</div>
      <div class="chip">‚ü≥ 15s</div>
    </div>
  </div>

  <div id="board">
    <h3>üèÜ Leaderboard (Top 15)</h3>
    <div class="grid head">
      <div class="cell rank">#</div>
      <div class="cell">Agente</div>
      <div class="cell team">Equipo</div>
      <div class="cell trans">Transfer</div>
    </div>
    <div id="rows" class="grid"></div>
  </div>

  <div id="overlay">
    <div id="card">
      <div id="who">Agente</div>
      <div id="meta">¬°acaba de rebasar! üéâ</div>
      <div id="trans">Transfer: 0</div>
    </div>
  </div>

  <div id="diag">Iniciando‚Ä¶</div>
</div></div>

<script>
/* ===== Config b√°sica ===== */
const API_KEY   = "AIzaSyB0TtVnOafgkbRwCaqkSxPogGLUgyWqZaE";
const SHEET_ID  = "1V1PtXIFUgb4Z3TWLNBll_HmLIiP6aeKe18rVIJClO8s";
const TIMEZONE  = "America/Tijuana";
const REFRESH_MS= 15000;
const PER_TEAM  = 10;
const TOP_LIMIT = 15;

/* ===== Helper: nombre de hoja por fecha local (America/Tijuana) =====
   Formato: 'Mon DD' en ingl√©s abreviado (ej. 'Oct 22').
   Adem√°s: si hay query ?sheet=Nov%2001 en la URL, lo respeta para pruebas.
*/
function fmtSheetName(date){
  const m = new Intl.DateTimeFormat('en-US',{month:'short', timeZone:TIMEZONE}).format(date);
  const d = new Intl.DateTimeFormat('en-US',{day:'2-digit', timeZone:TIMEZONE}).format(date);
  return `${m} ${d}`; // "Oct 22"
}
function getSheetNamePlan(){
  const url = new URL(window.location.href);
  const override = url.searchParams.get('sheet');
  if (override) return {primary: override, fallback: null, reason:'override'};
  const now = new Date();
  const yday = new Date(now.getTime()-24*60*60*1000);
  return {primary: fmtSheetName(now), fallback: fmtSheetName(yday), reason:'auto'};
}

/* ===== Utilidad UI ===== */
const DIAG=document.getElementById('diag');
const sheetTag=document.getElementById('sheetTag');
function diag(t,cls){ let tag=''; if(cls==='ok')tag='<span class=ok>OK</span> '; if(cls==='warn')tag='<span class=warn>WARN</span> '; if(cls==='err')tag='<span class=err>ERR</span> '; DIAG.innerHTML=tag+t; }
const emoji=/[\u{1F1E6}-\u{1F1FF}\u{1F300}-\u{1FAFF}\u{1F900}-\u{1F9FF}\u{2600}-\u{27BF}\u{FE0F}]/gu;
const clean=s=>(s||"").replace(emoji,"").normalize('NFD').replace(/[\u0300-\u036f]/g,"").replace(/[^\x20-\x7E]/g,"").replace(/\s{2,}/g," ").trim()||"Agente";
function dot(team){return `<span class="dot ${team==='Filekeepers'?'fk':'rg'}"></span>`;}
function renderRows(list){
  const rows=document.getElementById('rows'); rows.innerHTML="";
  list.slice(0,TOP_LIMIT).forEach((p,i)=>{
    rows.insertAdjacentHTML('beforeend', `
      <div class="cell rank">${i+1}</div>
      <div class="cell agent">${dot(p.team)} <span>${p.name}</span></div>
      <div class="cell team">${p.team}</div>
      <div class="cell trans">${p.transfer}</div>
    `);
  });
}

/* ===== Overlay felicidades (overtake) ===== */
const overlay=document.getElementById('overlay');
const whoEl=document.getElementById('who');
const transEl=document.getElementById('trans');
function showCongrats(p){
  whoEl.textContent=p.name; transEl.textContent=`Transfer: ${p.transfer}`;
  whoEl.classList.remove('accent-fk','accent-rg');
  whoEl.classList.add(p.team==='Filekeepers'?'accent-fk':'accent-rg');
  overlay.style.display='grid'; spawnConfetti(); setTimeout(()=>overlay.style.display='none',2500);
}
function spawnConfetti(){
  document.querySelectorAll('.confetti').forEach(e=>e.remove());
  const colors=['#ffd166','#06d6a0','#118ab2','#ef476f','#ffffff','#19ff9a','#ff3a46'];
  for(let i=0;i<60;i++){
    const d=document.createElement('div'); d.className='confetti';
    const size=8+Math.random()*10, left=Math.random()*100, delay=Math.random()*0.2, dur=1.3+Math.random()*0.7;
    d.style.left=left+'%'; d.style.background=colors[Math.floor(Math.random()*colors.length)];
    d.style.width=size+'px'; d.style.height=(size*1.6)+'px'; d.style.animationDuration=dur+'s'; d.style.animationDelay=delay+'s';
    overlay.appendChild(d);
  }
}

/* ===== Google Sheets ===== */
function encRange(name){ return encodeURIComponent("'"+name+"'"); }
async function fetchBatchFor(sheetName){
  const ranges=[`${encRange(sheetName)}!A2:A`,`${encRange(sheetName)}!C2:C`,`${encRange(sheetName)}!E2:E`,`${encRange(sheetName)}!G2:G`];
  const url=`https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values:batchGet?`+ranges.map(r=>`ranges=${r}`).join('&')+`&key=${API_KEY}`;
  const r=await fetch(url,{cache:"no-store"}); if(!r.ok) throw new Error(`HTTP ${r.status}`);
  return r.json();
}
const colToArr=vr=>!vr?.values?[]:vr.values.map(r=>String(r[0]||""));
function toPairs(names,transfers,limit,team){
  const n=Math.min(Math.max(names.length,transfers.length),limit), out=[];
  for(let i=0;i<n;i++){
    const nm=clean(names[i]); const t=parseInt((transfers[i]||'').trim())||0;
    out.push({name:nm, transfer:t, team});
  } return out;
}

/* ===== Overtakes ===== */
let prevRank=new Map();
function detectOvertakes(sorted){
  const now=new Map(); sorted.forEach((p,i)=>now.set(p.name,i));
  const up=[]; sorted.forEach((p,i)=>{ if(prevRank.has(p.name)){ const b=prevRank.get(p.name); if(i<b) up.push(p); }});
  prevRank=now; return up;
}

/* ===== Orquestaci√≥n con fallback de hoja ===== */
let ACTIVE_SHEET = null;

async function loadData(){
  const plan = getSheetNamePlan();
  const candidates = [plan.primary].concat(plan.fallback ? [plan.fallback] : []);
  let used=null, data=null, info=null;

  for (const name of candidates){
    try{
      const j=await fetchBatchFor(name); const vr=j.valueRanges||[];
      const fk=toPairs(colToArr(vr[0]), colToArr(vr[1]), PER_TEAM, 'Filekeepers');
      const rg=toPairs(colToArr(vr[2]), colToArr(vr[3]), PER_TEAM, 'Rugrats');
      const all=fk.concat(rg).sort((a,b)=> b.transfer - a.transfer);
      // Consideramos ‚Äúv√°lido‚Äù si hay al menos un valor num√©rico
      if (all.length && all.some(x=>x.transfer>0 || (x.name && x.name!=="Agente"))){
        used=name; data=all; info={fk:fk.length, rg:rg.length};
        break;
      }
    }catch(e){ /* continuar con siguiente */ }
  }

  if(!used){
    // si nada sirve, devolver falso y no cambiar ACTIVE_SHEET
    throw new Error(`No hay datos en las hojas: ${candidates.join(', ')}`);
  }
  ACTIVE_SHEET = used;
  return {data, info, used, tried:candidates};
}

/* ===== Loop ===== */
async function refresh(){
  try{
    const {data, info, used, tried} = await loadData();
    sheetTag.textContent = `üìÖ Hoja: ${used}`;
    const did = detectOvertakes(data);
    if (did.length) showCongrats(did.sort((a,b)=> b.transfer-a.transfer)[0]);
    renderRows(data);
    const note = (tried.length>1 && used===tried[1]) ? ' (fallback a d√≠a previo)' : '';
    diag(`Actualizado ‚Ä¢ Sheet usada: ${used}${note} ‚Ä¢ FK: ${info.fk} ¬∑ RG: ${info.rg} ¬∑ Top mostrado: ${Math.min(data.length, TOP_LIMIT)}`, 'ok');
  }catch(e){
    sheetTag.textContent = 'üìÖ Hoja: ‚Äî';
    diag('Error leyendo Sheets: '+(e.message||e), 'err');
  }
}

(async function start(){
  diag('Determinando hoja por fecha local (America/Tijuana)‚Ä¶');
  await refresh();
  setInterval(refresh, REFRESH_MS);
})();
</script>
</body>
</html>
''')
